<!DOCTYPE html><html class=astro-yjhsosxz data-has-sidebar data-has-toc data-theme=dark dir=ltr lang=en><head><meta charset=utf-8 /><meta content="width=device-width,initial-scale=1" name=viewport /><title>Content delivery network (CDN) setup | Adobe Commerce Storefront</title><link href=https://experienceleague.adobe.com/microsite-commerce-storefront/implementation/setup/content-delivery-network/ rel=canonical /><link href=/microsite-commerce-storefront/sitemap-index.xml rel=sitemap /><script src="https://assets.adobedtm.com/d4d114c60e50/9f881954c8dc/launch-7a902c4895c3.min.js&#34; async"></script><link href=/microsite-commerce-storefront/favicon.ico rel="shortcut icon" type=image/x-icon /><meta content="Astro v4.15.7" name=generator /><meta content="Starlight v0.26.4" name=generator /><meta content="Content delivery network (CDN) setup" property=og:title /><meta content=article property=og:type /><meta content=https://experienceleague.adobe.com/microsite-commerce-storefront/implementation/setup/content-delivery-network/ property=og:url /><meta content=en property=og:locale /><meta content="Learn how to configure a CDN for your Adobe Commerce on Edge Delivery Services storefront project." property=og:description /><meta content="Adobe Commerce Storefront" property=og:site_name /><meta content=summary_large_image name=twitter:card /><meta content="Learn how to configure a CDN for your Adobe Commerce on Edge Delivery Services storefront project." name=description /><meta content=NwoVbL9MrtJAa4vdfMC0vJmKV3Hvuc4L_UHlv4Uzjgk name=google-site-verification /><script>window.StarlightThemeProvider=(()=>{const e="undefined"!=typeof localStorage&&localStorage.getItem("starlight-theme"),t=e||(window.matchMedia("(prefers-color-scheme: light)").matches?"light":"dark");return document.documentElement.dataset.theme="light"===t?"light":"dark",{updatePickers(t=e||"auto"){document.querySelectorAll("starlight-theme-select").forEach((e=>{const o=e.querySelector("select");o&&(o.value=t);const c=document.querySelector("#theme-icons"),l=c&&c.content.querySelector("."+t);if(l){const t=e.querySelector("svg.label-icon");t&&t.replaceChildren(...l.cloneNode(!0).childNodes)}}))}}})()</script><template id=theme-icons><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-o5yzykuj light" style=--sl-icon-size:1em height=16 width=16><path d="M5 12a1 1 0 0 0-1-1H3a1 1 0 0 0 0 2h1a1 1 0 0 0 1-1Zm.64 5-.71.71a1 1 0 0 0 0 1.41 1 1 0 0 0 1.41 0l.71-.71A1 1 0 0 0 5.64 17ZM12 5a1 1 0 0 0 1-1V3a1 1 0 0 0-2 0v1a1 1 0 0 0 1 1Zm5.66 2.34a1 1 0 0 0 .7-.29l.71-.71a1 1 0 1 0-1.41-1.41l-.66.71a1 1 0 0 0 0 1.41 1 1 0 0 0 .66.29Zm-12-.29a1 1 0 0 0 1.41 0 1 1 0 0 0 0-1.41l-.71-.71a1.004 1.004 0 1 0-1.43 1.41l.73.71ZM21 11h-1a1 1 0 0 0 0 2h1a1 1 0 0 0 0-2Zm-2.64 6A1 1 0 0 0 17 18.36l.71.71a1 1 0 0 0 1.41 0 1 1 0 0 0 0-1.41l-.76-.66ZM12 6.5a5.5 5.5 0 1 0 5.5 5.5A5.51 5.51 0 0 0 12 6.5Zm0 9a3.5 3.5 0 1 1 0-7 3.5 3.5 0 0 1 0 7Zm0 3.5a1 1 0 0 0-1 1v1a1 1 0 0 0 2 0v-1a1 1 0 0 0-1-1Z"/></svg> <svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-o5yzykuj dark" style=--sl-icon-size:1em height=16 width=16><path d="M21.64 13a1 1 0 0 0-1.05-.14 8.049 8.049 0 0 1-3.37.73 8.15 8.15 0 0 1-8.14-8.1 8.59 8.59 0 0 1 .25-2A1 1 0 0 0 8 2.36a10.14 10.14 0 1 0 14 11.69 1 1 0 0 0-.36-1.05Zm-9.5 6.69A8.14 8.14 0 0 1 7.08 5.22v.27a10.15 10.15 0 0 0 10.14 10.14 9.784 9.784 0 0 0 2.1-.22 8.11 8.11 0 0 1-7.18 4.32v-.04Z"/></svg> <svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-o5yzykuj auto" style=--sl-icon-size:1em height=16 width=16><path d="M21 14h-1V7a3 3 0 0 0-3-3H7a3 3 0 0 0-3 3v7H3a1 1 0 0 0-1 1v2a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3v-2a1 1 0 0 0-1-1ZM6 7a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v7H6V7Zm14 10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-1h16v1Z"/></svg></template><link href=/microsite-commerce-storefront/_astro/index.2PewTndC.css rel=stylesheet><link href=/microsite-commerce-storefront/_astro/GraphiQLEditor.CtBXM7XM.css rel=stylesheet><link href=/microsite-commerce-storefront/_astro/commerce-boilerplate.CKanmkiN.css rel=stylesheet><style>:root{--sl-badge-default-border:var(--sl-color-accent);--sl-badge-default-bg:var(--sl-color-accent-low);--sl-badge-default-text:#fff;--sl-badge-note-border:var(--sl-color-blue);--sl-badge-note-bg:var(--sl-color-blue-low);--sl-badge-note-text:#fff;--sl-badge-danger-border:var(--sl-color-red);--sl-badge-danger-bg:var(--sl-color-red-low);--sl-badge-danger-text:#fff;--sl-badge-success-border:var(--sl-color-green);--sl-badge-success-bg:var(--sl-color-green-low);--sl-badge-success-text:#fff;--sl-badge-caution-border:var(--sl-color-orange);--sl-badge-caution-bg:var(--sl-color-orange-low);--sl-badge-caution-text:#fff;--sl-badge-tip-border:var(--sl-color-purple);--sl-badge-tip-bg:var(--sl-color-purple-low);--sl-badge-tip-text:#fff}[data-theme=light]:root{--sl-badge-default-bg:var(--sl-color-accent-high);--sl-badge-note-bg:var(--sl-color-blue-high);--sl-badge-danger-bg:var(--sl-color-red-high);--sl-badge-success-bg:var(--sl-color-green-high);--sl-badge-caution-bg:var(--sl-color-orange-high);--sl-badge-tip-bg:var(--sl-color-purple-high)}.sl-badge:where(.astro-zwsnp6p4){display:inline-block;border:1px solid var(--sl-color-border-badge);border-radius:.25rem;font-family:var(--sl-font-system-mono);line-height:normal;color:var(--sl-color-text-badge);background-color:var(--sl-color-bg-badge);overflow-wrap:anywhere}.sidebar-content .sl-badge:where(.astro-zwsnp6p4){line-height:1;font-size:var(--sl-text-xs);padding:.125rem .375rem}.sidebar-content a[aria-current=page]>.sl-badge:where(.astro-zwsnp6p4){--sl-color-bg-badge:transparent;--sl-color-border-badge:currentColor;color:inherit}.default:where(.astro-zwsnp6p4){--sl-color-bg-badge:var(--sl-badge-default-bg);--sl-color-border-badge:var(--sl-badge-default-border);--sl-color-text-badge:var(--sl-badge-default-text)}.note:where(.astro-zwsnp6p4){--sl-color-bg-badge:var(--sl-badge-note-bg);--sl-color-border-badge:var(--sl-badge-note-border);--sl-color-text-badge:var(--sl-badge-note-text)}.danger:where(.astro-zwsnp6p4){--sl-color-bg-badge:var(--sl-badge-danger-bg);--sl-color-border-badge:var(--sl-badge-danger-border);--sl-color-text-badge:var(--sl-badge-danger-text)}.success:where(.astro-zwsnp6p4){--sl-color-bg-badge:var(--sl-badge-success-bg);--sl-color-border-badge:var(--sl-badge-success-border);--sl-color-text-badge:var(--sl-badge-success-text)}.tip:where(.astro-zwsnp6p4){--sl-color-bg-badge:var(--sl-badge-tip-bg);--sl-color-border-badge:var(--sl-badge-tip-border);--sl-color-text-badge:var(--sl-badge-tip-text)}.caution:where(.astro-zwsnp6p4){--sl-color-bg-badge:var(--sl-badge-caution-bg);--sl-color-border-badge:var(--sl-badge-caution-border);--sl-color-text-badge:var(--sl-badge-caution-text)}.small:where(.astro-zwsnp6p4){font-size:var(--sl-text-xs);padding:.125rem .25rem}.medium:where(.astro-zwsnp6p4){font-size:var(--sl-text-sm);padding:.175rem .35rem}.large:where(.astro-zwsnp6p4){font-size:var(--sl-text-base);padding:.225rem .45rem}.sl-markdown-content :is(h1,h2,h3,h4,h5,h6) .sl-badge:where(.astro-zwsnp6p4){vertical-align:middle}.card-grid:where(.astro-wr6mxmeb){display:grid;gap:1rem}.card-grid:where(.astro-wr6mxmeb)>*{margin-top:0!important}@media (min-width:50rem){.card-grid:where(.astro-wr6mxmeb){grid-template-columns:1fr 1fr;gap:1.5rem}.stagger:where(.astro-wr6mxmeb){--stagger-height:5rem;padding-bottom:var(--stagger-height)}.stagger:where(.astro-wr6mxmeb)>:nth-child(2n){transform:translateY(var(--stagger-height))}}svg:where(.astro-ixejw5kg){color:var(--sl-icon-color);font-size:var(--sl-icon-size, 1em);width:1em;height:1em}svg:where(.astro-o5yzykuj){color:var(--sl-icon-color);font-size:var(--sl-icon-size, 1em);width:1em;height:1em}starlight-tabs:where(.astro-mjx25vee){display:block}.tablist-wrapper:where(.astro-mjx25vee){overflow-x:auto}:where(.astro-mjx25vee)[role=tablist]{display:flex;list-style:none;border-bottom:2px solid var(--sl-color-gray-5);padding:0}.tab:where(.astro-mjx25vee){margin-bottom:-2px}.tab:where(.astro-mjx25vee)>:where(.astro-mjx25vee)[role=tab]{display:flex;align-items:center;gap:.5rem;padding:0 1.25rem;text-decoration:none;border-bottom:2px solid var(--sl-color-gray-5);color:var(--sl-color-gray-3);outline-offset:var(--sl-outline-offset-inside);overflow-wrap:initial}.tab:where(.astro-mjx25vee) :where(.astro-mjx25vee)[role=tab][aria-selected=true]{color:var(--sl-color-white);border-color:var(--sl-color-text-accent);font-weight:600}.tablist-wrapper:where(.astro-mjx25vee)~[role=tabpanel]{margin-top:1rem}.sl-steps{--bullet-size:calc(var(--sl-line-height) * 1rem);--bullet-margin:.375rem;list-style:none;counter-reset:steps-counter var(--sl-steps-start,0);padding-inline-start:0}.sl-steps>li{counter-increment:steps-counter;position:relative;padding-inline-start:calc(var(--bullet-size) + 1rem);padding-bottom:1px;min-height:calc(var(--bullet-size) + var(--bullet-margin))}.sl-steps>li+li{margin-top:0}.sl-steps>li:before{content:counter(steps-counter);position:absolute;top:0;inset-inline-start:0;width:var(--bullet-size);height:var(--bullet-size);line-height:var(--bullet-size);font-size:var(--sl-text-xs);font-weight:600;text-align:center;color:var(--sl-color-white);background-color:var(--sl-color-gray-6);border-radius:99rem;box-shadow:inset 0 0 0 1px var(--sl-color-gray-5)}.sl-steps>li:after{--guide-width:1px;content:"";position:absolute;top:calc(var(--bullet-size) + var(--bullet-margin));bottom:var(--bullet-margin);inset-inline-start:calc((var(--bullet-size) - var(--guide-width))/ 2);width:var(--guide-width);background-color:var(--sl-color-hairline-light)}.sl-steps>li>:first-child{--lh:calc(1em * var(--sl-line-height));--shift-y:calc(.5 * (var(--bullet-size) - var(--lh)));transform:translateY(var(--shift-y));margin-bottom:var(--shift-y)}.sl-steps>li>:first-child:where(h1,h2,h3,h4,h5,h6){--lh:calc(1em * var(--sl-line-height-headings))}@supports (--prop:1lh){.sl-steps>li>:first-child{--lh:1lh}}</style><script src=/microsite-commerce-storefront/_astro/hoisted.CrkyGfVT.js type=module></script><script src=/microsite-commerce-storefront/_astro/page.BJIqRAvy.js type=module></script><style>.ac-task.ac-task{--bullet-size:2.5rem;border-radius:.5rem;border:1px solid var(--sl-color-gray-5);background-color:var(--sl-color-gray-8);color:var(--sl-color-gray-1);margin-top:2rem;margin-bottom:2rem;margin-left:-1rem;overflow-wrap:break-word;padding-left:1rem;padding-right:1rem;padding-bottom:1rem}.ac-task.ac-task>ol{color:var(--sl-color-gray-1);padding-left:1rem}.ac-task.ac-task>h3{counter-increment:task;color:var(--sl-color-gray-1);line-height:1;padding-left:0;margin-bottom:.5rem}.ac-task.ac-task>h3:before{content:"Step " counter(task);display:inline-block;text-align:center;vertical-align:middle;border-radius:var(--radius);font-size:1rem;height:1.75rem;width:4rem;line-height:1.6rem;color:var(--sl-color-black);background-color:var(--sl-color-accent);margin-left:-1.5rem;margin-right:-.25rem;margin-top:-2.25rem;position:absolute;border-radius:.25rem}</style><style>.ac-tasks.ac-tasks{counter-reset:task;padding-left:1.5rem;margin-bottom:2rem}</style><script src=/microsite-commerce-storefront/_astro/Tabs.astro_astro_type_script_index_0_lang.3nBd5krW.js type=module></script></head><body class=astro-yjhsosxz><a href=#_top class=astro-ekarkfac>Skip to content</a><div class="sl-flex astro-bk6v3icc page"><header class="header astro-bk6v3icc"><div class="header astro-bkumecsx sl-flex"><div class="sl-flex astro-bkumecsx title-wrapper"><a href=/microsite-commerce-storefront/ class="sl-flex astro-joi45scb site-title"><img alt="" height=245 src=/microsite-commerce-storefront/_astro/sitelogo.f1OrlS7L.svg width=250 class=astro-joi45scb> <span class=astro-joi45scb>Adobe Commerce Storefront</span></a><div class="sl-flex astro-bkumecsx left-group"><a href=/microsite-commerce-storefront/get-started/ class="astro-bkumecsx header-link">Docs</a> <a href=/microsite-commerce-storefront/playgrounds/commerce-services/ class="astro-bkumecsx header-link">Playgrounds</a> <a href=/microsite-commerce-storefront/videos/ class="astro-bkumecsx header-link">Videos</a></div></div><div class="sl-flex astro-bkumecsx center-group"><site-search class=astro-cnujcskq data-translations={&#34;placeholder&#34;:&#34;Search&#34;}><button class=astro-cnujcskq aria-label=Search aria-keyshortcuts=Control+K data-open-modal disabled=disabled><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-cnujcskq astro-o5yzykuj" style=--sl-icon-size:1em height=16 width=16><path d="M21.71 20.29 18 16.61A9 9 0 1 0 16.61 18l3.68 3.68a.999.999 0 0 0 1.42 0 1 1 0 0 0 0-1.39ZM11 18a7 7 0 1 1 0-14 7 7 0 0 1 0 14Z"/></svg> <span class="astro-cnujcskq sl-hidden md:sl-block" aria-hidden=true>Search</span> <kbd class="astro-cnujcskq sl-hidden md:sl-flex" style=display:none><kbd class=astro-cnujcskq>Ctrl</kbd><kbd class=astro-cnujcskq>K</kbd></kbd></button><dialog class=astro-cnujcskq aria-label=Search style=padding:0><div class="sl-flex astro-cnujcskq dialog-frame"><button class="sl-flex astro-cnujcskq md:sl-hidden" data-close-modal>Cancel</button><div class=astro-cnujcskq dir=ltr style=margin:auto;text-align:center;white-space:pre-line><p class=astro-cnujcskq>Search is only available in production builds. Try building and previewing the site to test it out locally.</p></div></div></dialog></site-search><script>(()=>{const t=document.querySelector("button[data-open-modal]"),e=t?.querySelector("kbd");if(!(t&&e instanceof HTMLElement))return;const o=e.querySelector("kbd");o&&/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform)&&(o.textContent="⌘",t.setAttribute("aria-keyshortcuts","Meta+K")),e.style.display=""})()</script></div><div class="astro-bkumecsx md:sl-flex right-group sl-hidden"><div class="sl-flex astro-bkumecsx social-icons"><a href=/microsite-commerce-storefront/superstar/ class=astro-bkumecsx aria-label="Storefront Superstart"><svg fill=currentColor viewBox="0 0 24 24" class="astro-ixejw5kg astro-bkumecsx storefront-superstars" style=--sl-icon-color:#f2cc7c;--sl-icon-size:1.25rem aria-label="Storefront Superstars"><title>Storefront Superstars</title><path d="M8.295 8.200L11.981 0.714L15.667 8.200L23.875 9.378L17.909 15.078L19.353 23.286L11.981 19.486L4.609 23.286L6.053 15.078L0.125 9.378L8.295 8.200Z"/></svg> </a><a href=https://discord.com/channels/1131492224371277874/1220042081209421945 class="sl-flex astro-r3tjzkat" rel=me><span class="astro-r3tjzkat sr-only">Discord</span><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-ixejw5kg astro-r3tjzkat" style=--sl-icon-size:1.25rem><title></title><path d="M20.32 4.37a19.8 19.8 0 0 0-4.93-1.51 13.78 13.78 0 0 0-.64 1.28 18.27 18.27 0 0 0-5.5 0 12.64 12.64 0 0 0-.64-1.28h-.05A19.74 19.74 0 0 0 3.64 4.4 20.26 20.26 0 0 0 .11 18.09l.02.02a19.9 19.9 0 0 0 6.04 3.03l.04-.02a14.24 14.24 0 0 0 1.23-2.03.08.08 0 0 0-.05-.07 13.1 13.1 0 0 1-1.9-.92.08.08 0 0 1 .02-.1 10.2 10.2 0 0 0 .41-.31h.04a14.2 14.2 0 0 0 12.1 0l.04.01a9.63 9.63 0 0 0 .4.32.08.08 0 0 1-.03.1 12.29 12.29 0 0 1-1.9.91.08.08 0 0 0-.02.1 15.97 15.97 0 0 0 1.27 2.01h.04a19.84 19.84 0 0 0 6.03-3.05v-.03a20.12 20.12 0 0 0-3.57-13.69ZM8.02 15.33c-1.18 0-2.16-1.08-2.16-2.42 0-1.33.96-2.42 2.16-2.42 1.21 0 2.18 1.1 2.16 2.42 0 1.34-.96 2.42-2.16 2.42Zm7.97 0c-1.18 0-2.15-1.08-2.15-2.42 0-1.33.95-2.42 2.15-2.42 1.22 0 2.18 1.1 2.16 2.42 0 1.34-.94 2.42-2.16 2.42Z"/></svg> </a><a href=https://github.com/commerce-docs/microsite-commerce-storefront/tree/develop class="sl-flex astro-r3tjzkat" rel=me><span class="astro-r3tjzkat sr-only">GitHub</span><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-ixejw5kg astro-r3tjzkat" style=--sl-icon-size:1.25rem><title></title><circle cx=12 cy=12 fill=#FFF r=12 /><path d="M12 1a11 11 0 0 0-3.5 21.5c.6 0 .8-.3.8-.5v-2.1c-3.1.7-3.7-1.3-3.7-1.3C5 17.3 4.3 17 4.3 17c-1-.7.1-.7.1-.7 1.1 0 1.7 1.1 1.7 1.1 1 1.7 2.6 1.2 3.2 1 0-.8.4-1.2.7-1.5-2.5-.3-5-1.2-5-5.5 0-1.2.4-2.2 1.1-3a4 4 0 0 1 .1-2.8s1-.3 3 1c1.8-.4 3.8-.4 5.5 0 2.1-1.3 3-1 3-1 .7 1.5.3 2.6.2 2.9.7.8 1.1 1.7 1.1 3 0 4.2-2.6 5.1-5 5.4.4.3.7 1 .7 2v3c0 .3.2.7.8.6A11 11 0 0 0 12 1Z" fill=#161614 /></svg> </a><a href=https://experienceleague.adobe.com/en/docs/commerce-admin/start/guide-overview class="sl-flex astro-r3tjzkat" rel=me><span class="astro-r3tjzkat sr-only">Commerce</span><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-ixejw5kg astro-r3tjzkat" style=--sl-icon-size:1.25rem><title></title><path d="M8.87361 1H0V22.2914L8.87361 1Z" fill=#FA0C00 /><path d="M15.1166 1H23.9789V22.2914L15.1166 1Z" fill=#FA0C00 /><path d="M11.9951 8.84741L17.643 22.2914H13.9377L12.2493 18.0109H8.11623L11.9951 8.84741Z" fill=#FA0C00 /></svg></a></div><starlight-theme-select><label class=astro-brjctaie style=--sl-select-width:6.25em><span class="sr-only astro-brjctaie">Select theme</span> <svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-brjctaie astro-o5yzykuj icon label-icon" style=--sl-icon-size:1em height=16 width=16><path d="M21 14h-1V7a3 3 0 0 0-3-3H7a3 3 0 0 0-3 3v7H3a1 1 0 0 0-1 1v2a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3v-2a1 1 0 0 0-1-1ZM6 7a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v7H6V7Zm14 10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-1h16v1Z"/></svg> <select class=astro-brjctaie value=auto><option class=astro-brjctaie value=dark>Dark</option><option class=astro-brjctaie value=light>Light</option><option class=astro-brjctaie value=auto selected=true>Auto</option></select> <svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-brjctaie astro-o5yzykuj icon caret" style=--sl-icon-size:1em height=16 width=16><path d="M17 9.17a1 1 0 0 0-1.41 0L12 12.71 8.46 9.17a1 1 0 1 0-1.41 1.42l4.24 4.24a1.002 1.002 0 0 0 1.42 0L17 10.59a1.002 1.002 0 0 0 0-1.42Z"/></svg></label></starlight-theme-select><script>StarlightThemeProvider.updatePickers()</script></div></div></header><nav class="astro-bk6v3icc sidebar" aria-label=Main><starlight-menu-button class=astro-wpac4gj4><button class="sl-flex md:sl-hidden astro-wpac4gj4" aria-label=Menu aria-controls=starlight__sidebar aria-expanded=false><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-o5yzykuj astro-wpac4gj4" style=--sl-icon-size:1em height=16 width=16><path d="M3 8h18a1 1 0 1 0 0-2H3a1 1 0 0 0 0 2Zm18 8H3a1 1 0 0 0 0 2h18a1 1 0 0 0 0-2Zm0-5H3a1 1 0 0 0 0 2h18a1 1 0 0 0 0-2Z"/></svg></button></starlight-menu-button><div class="astro-bk6v3icc sidebar-pane" id=starlight__sidebar><div class="sl-flex astro-bk6v3icc sidebar-content"><ul class="astro-ho4vn3za top-level"><li class=astro-ho4vn3za><details class=astro-ho4vn3za open><summary class=astro-ho4vn3za><div class="astro-ho4vn3za group-label"><span class="astro-ho4vn3za large">Get Started</span></div><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-ho4vn3za astro-ixejw5kg caret" style=--sl-icon-size:1.25rem><title></title><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg></summary><ul class=astro-ho4vn3za><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/get-started/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Create your storefront</span></a></li><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/get-started/run-lighthouse/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Run Lighthouse audits</span></a></li><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/get-started/storefront-structure/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Explore the structure</span></a></li></ul></details></li><li class=astro-ho4vn3za><details class=astro-ho4vn3za open><summary class=astro-ho4vn3za><div class="astro-ho4vn3za group-label"><span class="astro-ho4vn3za large">Storefront Implementation</span></div><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-ho4vn3za astro-ixejw5kg caret" style=--sl-icon-size:1.25rem><title></title><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg></summary><ul class=astro-ho4vn3za><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/implementation/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Overview</span></a></li><li class=astro-ho4vn3za><details class=astro-ho4vn3za><summary class=astro-ho4vn3za><div class="astro-ho4vn3za group-label"><span class="astro-ho4vn3za large">Discovery</span></div><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-ho4vn3za astro-ixejw5kg caret" style=--sl-icon-size:1.25rem><title></title><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg></summary><ul class=astro-ho4vn3za><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/implementation/discovery/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Overview</span></a></li><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/implementation/discovery/requirements/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Commerce requirements</span></a></li><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/implementation/discovery/data-export-validation/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Data export validation</span></a></li><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/implementation/discovery/luma-bridge/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Luma Bridge</span></a></li></ul></details></li><li class=astro-ho4vn3za><details class=astro-ho4vn3za open><summary class=astro-ho4vn3za><div class="astro-ho4vn3za group-label"><span class="astro-ho4vn3za large">Setup</span></div><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-ho4vn3za astro-ixejw5kg caret" style=--sl-icon-size:1.25rem><title></title><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg></summary><ul class=astro-ho4vn3za><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/implementation/setup/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Overview</span></a></li><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/implementation/setup/content-delivery-network/ class=astro-ho4vn3za aria-current=page><span class=astro-ho4vn3za>Content delivery network</span></a></li><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/implementation/setup/commerce-configuration/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Commerce configuration</span></a></li><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/implementation/setup/dropins-and-widgets/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Dropins and widgets</span></a></li><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/implementation/setup/commerce-blocks/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Commerce blocks</span></a></li></ul></details></li><li class=astro-ho4vn3za><details class=astro-ho4vn3za><summary class=astro-ho4vn3za><div class="astro-ho4vn3za group-label"><span class="astro-ho4vn3za large">Marketing and SEO</span></div><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-ho4vn3za astro-ixejw5kg caret" style=--sl-icon-size:1.25rem><title></title><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg></summary><ul class=astro-ho4vn3za><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/implementation/marketing/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Overview</span></a></li><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/implementation/marketing/commerce-instrumentation/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Instrumentation</span></a></li><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/implementation/marketing/seo/ class=astro-ho4vn3za><span class=astro-ho4vn3za>SEO</span></a></li><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/implementation/marketing/metadata/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Metadata</span></a></li></ul></details></li><li class=astro-ho4vn3za><details class=astro-ho4vn3za><summary class=astro-ho4vn3za><div class="astro-ho4vn3za group-label"><span class="astro-ho4vn3za large">Launch</span></div><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-ho4vn3za astro-ixejw5kg caret" style=--sl-icon-size:1.25rem><title></title><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg></summary><ul class=astro-ho4vn3za><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/implementation/launch/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Overview</span></a></li><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/implementation/launch/checklist/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Checklist</span></a></li></ul></details></li></ul></details></li><li class=astro-ho4vn3za><details class=astro-ho4vn3za open><summary class=astro-ho4vn3za><div class="astro-ho4vn3za group-label"><span class="astro-ho4vn3za large">Dropins</span></div><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-ho4vn3za astro-ixejw5kg caret" style=--sl-icon-size:1.25rem><title></title><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg></summary><ul class=astro-ho4vn3za><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/dropins/all/introduction/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Overview</span></a></li><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/dropins/all/installing/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Installing dropins</span></a></li><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/dropins/all/branding/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Branding dropins</span></a></li><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/dropins/all/styling/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Styling dropins</span></a></li><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/dropins/all/extending/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Extending dropins</span></a></li><li class=astro-ho4vn3za><details class=astro-ho4vn3za open><summary class=astro-ho4vn3za><div class="astro-ho4vn3za group-label"><span class="astro-ho4vn3za large">Product Details Page</span></div><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-ho4vn3za astro-ixejw5kg caret" style=--sl-icon-size:1.25rem><title></title><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg></summary><ul class=astro-ho4vn3za><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/dropins/product-details/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Overview</span></a></li><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/dropins/product-details/pdp-installation/ class=astro-ho4vn3za><span class=astro-ho4vn3za>PDP Installation</span></a></li><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/dropins/product-details/pdp-styles/ class=astro-ho4vn3za><span class=astro-ho4vn3za>PDP Styles</span></a></li><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/dropins/product-details/pdp-containers/ class=astro-ho4vn3za><span class=astro-ho4vn3za>PDP Containers</span></a></li><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/dropins/product-details/pdp-slots/ class=astro-ho4vn3za><span class=astro-ho4vn3za>PDP Slots</span></a></li><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/dropins/product-details/pdp-functions/ class=astro-ho4vn3za><span class=astro-ho4vn3za>PDP Functions</span></a></li></ul></details></li><li class=astro-ho4vn3za><details class=astro-ho4vn3za><summary class=astro-ho4vn3za><div class="astro-ho4vn3za group-label"><span class="astro-ho4vn3za large">Cart</span></div><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-ho4vn3za astro-ixejw5kg caret" style=--sl-icon-size:1.25rem><title></title><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg></summary><ul class=astro-ho4vn3za><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/dropins/cart/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Overview</span></a></li><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/dropins/cart/cart-installation/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Cart Installation</span></a></li><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/dropins/cart/cart-styles/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Cart Styles</span></a></li><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/dropins/cart/cart-containers/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Cart Containers</span></a></li><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/dropins/cart/cart-slots/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Cart Slots</span></a></li><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/dropins/cart/cart-functions/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Cart Functions</span></a></li></ul></details></li><li class=astro-ho4vn3za><details class=astro-ho4vn3za><summary class=astro-ho4vn3za><div class="astro-ho4vn3za group-label"><span class="astro-ho4vn3za large">Checkout</span></div><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-ho4vn3za astro-ixejw5kg caret" style=--sl-icon-size:1.25rem><title></title><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg></summary><ul class=astro-ho4vn3za><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/dropins/checkout/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Overview</span></a></li></ul></details></li><li class=astro-ho4vn3za><details class=astro-ho4vn3za><summary class=astro-ho4vn3za><div class="astro-ho4vn3za group-label"><span class="astro-ho4vn3za large">User Auth</span></div><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-ho4vn3za astro-ixejw5kg caret" style=--sl-icon-size:1.25rem><title></title><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg></summary><ul class=astro-ho4vn3za><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/dropins/user-auth/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Overview</span></a></li></ul></details></li><li class=astro-ho4vn3za><details class=astro-ho4vn3za><summary class=astro-ho4vn3za><div class="astro-ho4vn3za group-label"><span class="astro-ho4vn3za large">User Account</span></div><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-ho4vn3za astro-ixejw5kg caret" style=--sl-icon-size:1.25rem><title></title><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg></summary><ul class=astro-ho4vn3za><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/dropins/user-account/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Overview</span></a></li></ul></details></li></ul></details></li><li class=astro-ho4vn3za><details class=astro-ho4vn3za open><summary class=astro-ho4vn3za><div class="astro-ho4vn3za group-label"><span class="astro-ho4vn3za large">Toubleshooting</span></div><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-ho4vn3za astro-ixejw5kg caret" style=--sl-icon-size:1.25rem><title></title><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg></summary><ul class=astro-ho4vn3za><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/troubleshooting/faq/ class=astro-ho4vn3za><span class=astro-ho4vn3za>Frequently Asked Questions (FAQ)</span></a></li><li class=astro-ho4vn3za><a href=/microsite-commerce-storefront/troubleshooting/pagespeed-issues/ class=astro-ho4vn3za><span class=astro-ho4vn3za>PageSpeed Insights issues</span></a></li></ul></details></li></ul><div class="astro-eiubaq5o md:sl-hidden"><div class="sl-flex astro-ekq3ejrw mobile-preferences"><div class="sl-flex astro-ekq3ejrw social-icons"><a href=https://discord.com/channels/1131492224371277874/1220042081209421945 class="sl-flex astro-r3tjzkat" rel=me><span class="astro-r3tjzkat sr-only">Discord</span><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-ixejw5kg astro-r3tjzkat" style=--sl-icon-size:1.25rem><title></title><path d="M20.32 4.37a19.8 19.8 0 0 0-4.93-1.51 13.78 13.78 0 0 0-.64 1.28 18.27 18.27 0 0 0-5.5 0 12.64 12.64 0 0 0-.64-1.28h-.05A19.74 19.74 0 0 0 3.64 4.4 20.26 20.26 0 0 0 .11 18.09l.02.02a19.9 19.9 0 0 0 6.04 3.03l.04-.02a14.24 14.24 0 0 0 1.23-2.03.08.08 0 0 0-.05-.07 13.1 13.1 0 0 1-1.9-.92.08.08 0 0 1 .02-.1 10.2 10.2 0 0 0 .41-.31h.04a14.2 14.2 0 0 0 12.1 0l.04.01a9.63 9.63 0 0 0 .4.32.08.08 0 0 1-.03.1 12.29 12.29 0 0 1-1.9.91.08.08 0 0 0-.02.1 15.97 15.97 0 0 0 1.27 2.01h.04a19.84 19.84 0 0 0 6.03-3.05v-.03a20.12 20.12 0 0 0-3.57-13.69ZM8.02 15.33c-1.18 0-2.16-1.08-2.16-2.42 0-1.33.96-2.42 2.16-2.42 1.21 0 2.18 1.1 2.16 2.42 0 1.34-.96 2.42-2.16 2.42Zm7.97 0c-1.18 0-2.15-1.08-2.15-2.42 0-1.33.95-2.42 2.15-2.42 1.22 0 2.18 1.1 2.16 2.42 0 1.34-.94 2.42-2.16 2.42Z"/></svg> </a><a href=https://github.com/commerce-docs/microsite-commerce-storefront/tree/develop class="sl-flex astro-r3tjzkat" rel=me><span class="astro-r3tjzkat sr-only">GitHub</span><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-ixejw5kg astro-r3tjzkat" style=--sl-icon-size:1.25rem><title></title><circle cx=12 cy=12 fill=#FFF r=12 /><path d="M12 1a11 11 0 0 0-3.5 21.5c.6 0 .8-.3.8-.5v-2.1c-3.1.7-3.7-1.3-3.7-1.3C5 17.3 4.3 17 4.3 17c-1-.7.1-.7.1-.7 1.1 0 1.7 1.1 1.7 1.1 1 1.7 2.6 1.2 3.2 1 0-.8.4-1.2.7-1.5-2.5-.3-5-1.2-5-5.5 0-1.2.4-2.2 1.1-3a4 4 0 0 1 .1-2.8s1-.3 3 1c1.8-.4 3.8-.4 5.5 0 2.1-1.3 3-1 3-1 .7 1.5.3 2.6.2 2.9.7.8 1.1 1.7 1.1 3 0 4.2-2.6 5.1-5 5.4.4.3.7 1 .7 2v3c0 .3.2.7.8.6A11 11 0 0 0 12 1Z" fill=#161614 /></svg> </a><a href=https://experienceleague.adobe.com/en/docs/commerce-admin/start/guide-overview class="sl-flex astro-r3tjzkat" rel=me><span class="astro-r3tjzkat sr-only">Commerce</span><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-ixejw5kg astro-r3tjzkat" style=--sl-icon-size:1.25rem><title></title><path d="M8.87361 1H0V22.2914L8.87361 1Z" fill=#FA0C00 /><path d="M15.1166 1H23.9789V22.2914L15.1166 1Z" fill=#FA0C00 /><path d="M11.9951 8.84741L17.643 22.2914H13.9377L12.2493 18.0109H8.11623L11.9951 8.84741Z" fill=#FA0C00 /></svg></a></div><starlight-theme-select><label class=astro-brjctaie style=--sl-select-width:6.25em><span class="sr-only astro-brjctaie">Select theme</span> <svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-brjctaie astro-o5yzykuj icon label-icon" style=--sl-icon-size:1em height=16 width=16><path d="M21 14h-1V7a3 3 0 0 0-3-3H7a3 3 0 0 0-3 3v7H3a1 1 0 0 0-1 1v2a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3v-2a1 1 0 0 0-1-1ZM6 7a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v7H6V7Zm14 10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-1h16v1Z"/></svg> <select class=astro-brjctaie value=auto><option class=astro-brjctaie value=dark>Dark</option><option class=astro-brjctaie value=light>Light</option><option class=astro-brjctaie value=auto selected=true>Auto</option></select> <svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-brjctaie astro-o5yzykuj icon caret" style=--sl-icon-size:1em height=16 width=16><path d="M17 9.17a1 1 0 0 0-1.41 0L12 12.71 8.46 9.17a1 1 0 1 0-1.41 1.42l4.24 4.24a1.002 1.002 0 0 0 1.42 0L17 10.59a1.002 1.002 0 0 0 0-1.42Z"/></svg></label></starlight-theme-select><script>StarlightThemeProvider.updatePickers()</script></div></div><script>(()=>{const e=document.querySelector("#starlight__sidebar");if(!e)return;const t=e.querySelectorAll("details"),o=JSON.parse(sessionStorage.getItem("starlight_sidebar")??"{}"),{top:r,collapse:s}=o;void 0!==r&&s&&s.length===t.length&&(t.forEach(((e,t)=>{e.open=s[t]})),e.scrollTop=r),window.addEventListener("beforeunload",(()=>{const o=Array.from(t).map((e=>e.open));sessionStorage.setItem("starlight_sidebar",JSON.stringify({top:e.scrollTop,collapse:o}))}))})()</script></div></div></nav><div class="astro-bk6v3icc main-frame"><div class="astro-dnpl4iv7 lg:sl-flex"><aside class="astro-dnpl4iv7 right-sidebar-container"><div class="astro-dnpl4iv7 right-sidebar"><div class="astro-xbtg6jy7 lg:sl-hidden"><mobile-starlight-toc class=astro-zxjnbzt7 data-max-h=3 data-min-h=2><nav aria-labelledby=starlight__on-this-page--mobile class=astro-zxjnbzt7><details class=astro-zxjnbzt7 id=starlight__mobile-toc><summary class="sl-flex astro-zxjnbzt7" id=starlight__on-this-page--mobile><div class="sl-flex astro-zxjnbzt7 toggle">On this page<svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-o5yzykuj caret astro-zxjnbzt7" style=--sl-icon-size:1rem height=16 width=16><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg></div><span class="astro-zxjnbzt7 display-current"></span></summary><div class="astro-zxjnbzt7 dropdown"><ul class="astro-hlx5hkdr isMobile" style=--depth:0><li class=astro-hlx5hkdr style=--depth:0><a href=#_top class=astro-hlx5hkdr style=--depth:0><span style=--depth:0 class=astro-hlx5hkdr>Overview</span></a></li><li class=astro-hlx5hkdr style=--depth:0><a href=#configuration-blueprint class=astro-hlx5hkdr style=--depth:0><span style=--depth:0 class=astro-hlx5hkdr>Configuration (blueprint)</span></a></li><li class=astro-hlx5hkdr style=--depth:0><a href=#cache-validation-blueprint class=astro-hlx5hkdr style=--depth:0><span style=--depth:0 class=astro-hlx5hkdr>Cache validation (blueprint)</span></a></li><li class=astro-hlx5hkdr style=--depth:0><a href=#surrogate-key-validation-blueprint class=astro-hlx5hkdr style=--depth:0><span style=--depth:0 class=astro-hlx5hkdr>Surrogate key validation (blueprint)</span></a></li><li class=astro-hlx5hkdr style=--depth:0><a href=#routing-use-cases class=astro-hlx5hkdr style=--depth:0><span style=--depth:0 class=astro-hlx5hkdr>Routing Use Cases</span></a><ul class="astro-hlx5hkdr isMobile" style=--depth:1><li class=astro-hlx5hkdr style=--depth:1><a href=#use-case-a-full-storefront class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>Use Case A: Full Storefront</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#use-case-b-luma-bridge class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>Use Case B: Luma Bridge</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#use-case-c-homepage-only class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>Use Case C: Homepage only</span></a></li></ul></li><li class=astro-hlx5hkdr style=--depth:0><a href=#backend-configuration class=astro-hlx5hkdr style=--depth:0><span style=--depth:0 class=astro-hlx5hkdr>Backend configuration</span></a></li><li class=astro-hlx5hkdr style=--depth:0><a href=#vcl-configuration class=astro-hlx5hkdr style=--depth:0><span style=--depth:0 class=astro-hlx5hkdr>VCL configuration</span></a><ul class="astro-hlx5hkdr isMobile" style=--depth:1><li class=astro-hlx5hkdr style=--depth:1><a href=#recv class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>recv</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#pass class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>pass</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#miss class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>miss</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#fetch class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>fetch</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#deliver class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>deliver</span></a></li></ul></li><li class=astro-hlx5hkdr style=--depth:0><a href=#optional-configuration class=astro-hlx5hkdr style=--depth:0><span style=--depth:0 class=astro-hlx5hkdr>Optional configuration</span></a><ul class="astro-hlx5hkdr isMobile" style=--depth:1><li class=astro-hlx5hkdr style=--depth:1><a href=#rewrite-urls-to-remove-unsupported-characters class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>Rewrite URLs to remove unsupported characters</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#proxy-rum-through-the-origin-to-avoid-a-tls-to-rum-service class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>Proxy RUM through the origin to avoid a TLS to rum service</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#shielding class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>Shielding</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#compression class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>Compression</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#failover class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>Failover</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#api-mesh-header-size-limit class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>API Mesh Header Size Limit</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#use-branch-names-on-staging class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>Use branch names on staging</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#maintainance-page-workaround class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>Maintainance page workaround</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#mulitple-setcookie-headers-issue class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>Mulitple setcookie headers issue</span></a></li></ul></li><li class=astro-hlx5hkdr style=--depth:0><a href=#commerce-configuration class=astro-hlx5hkdr style=--depth:0><span style=--depth:0 class=astro-hlx5hkdr>Commerce configuration</span></a></li><li class=astro-hlx5hkdr style=--depth:0><a href=#edge-delivery-service-configuration class=astro-hlx5hkdr style=--depth:0><span style=--depth:0 class=astro-hlx5hkdr>Edge Delivery Service configuration</span></a></li><li class=astro-hlx5hkdr style=--depth:0><a href=#validation class=astro-hlx5hkdr style=--depth:0><span style=--depth:0 class=astro-hlx5hkdr>Validation</span></a><ul class="astro-hlx5hkdr isMobile" style=--depth:1><li class=astro-hlx5hkdr style=--depth:1><a href=#eds-content-encoding-surrogate-key-and-cache class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>EDS content encoding, surrogate key, and cache</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#eds-and-commerce-image-optimization class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>EDS and Commerce image optimization</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#commerce-cache class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>Commerce cache</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#commerce-base-url class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>Commerce base URL</span></a></li></ul></li><li class=astro-hlx5hkdr style=--depth:0><a href=#debugging class=astro-hlx5hkdr style=--depth:0><span style=--depth:0 class=astro-hlx5hkdr>Debugging</span></a></li></ul></div></details></nav></mobile-starlight-toc></div><div class="astro-xbtg6jy7 lg:sl-block right-sidebar-panel sl-hidden"><div class="astro-xbtg6jy7 sl-container"><starlight-toc data-max-h=3 data-min-h=2><nav aria-labelledby=starlight__on-this-page><h2 id=starlight__on-this-page>On this page</h2><ul class=astro-hlx5hkdr style=--depth:0><li class=astro-hlx5hkdr style=--depth:0><a href=#_top class=astro-hlx5hkdr style=--depth:0><span style=--depth:0 class=astro-hlx5hkdr>Overview</span></a></li><li class=astro-hlx5hkdr style=--depth:0><a href=#configuration-blueprint class=astro-hlx5hkdr style=--depth:0><span style=--depth:0 class=astro-hlx5hkdr>Configuration (blueprint)</span></a></li><li class=astro-hlx5hkdr style=--depth:0><a href=#cache-validation-blueprint class=astro-hlx5hkdr style=--depth:0><span style=--depth:0 class=astro-hlx5hkdr>Cache validation (blueprint)</span></a></li><li class=astro-hlx5hkdr style=--depth:0><a href=#surrogate-key-validation-blueprint class=astro-hlx5hkdr style=--depth:0><span style=--depth:0 class=astro-hlx5hkdr>Surrogate key validation (blueprint)</span></a></li><li class=astro-hlx5hkdr style=--depth:0><a href=#routing-use-cases class=astro-hlx5hkdr style=--depth:0><span style=--depth:0 class=astro-hlx5hkdr>Routing Use Cases</span></a><ul class=astro-hlx5hkdr style=--depth:1><li class=astro-hlx5hkdr style=--depth:1><a href=#use-case-a-full-storefront class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>Use Case A: Full Storefront</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#use-case-b-luma-bridge class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>Use Case B: Luma Bridge</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#use-case-c-homepage-only class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>Use Case C: Homepage only</span></a></li></ul></li><li class=astro-hlx5hkdr style=--depth:0><a href=#backend-configuration class=astro-hlx5hkdr style=--depth:0><span style=--depth:0 class=astro-hlx5hkdr>Backend configuration</span></a></li><li class=astro-hlx5hkdr style=--depth:0><a href=#vcl-configuration class=astro-hlx5hkdr style=--depth:0><span style=--depth:0 class=astro-hlx5hkdr>VCL configuration</span></a><ul class=astro-hlx5hkdr style=--depth:1><li class=astro-hlx5hkdr style=--depth:1><a href=#recv class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>recv</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#pass class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>pass</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#miss class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>miss</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#fetch class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>fetch</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#deliver class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>deliver</span></a></li></ul></li><li class=astro-hlx5hkdr style=--depth:0><a href=#optional-configuration class=astro-hlx5hkdr style=--depth:0><span style=--depth:0 class=astro-hlx5hkdr>Optional configuration</span></a><ul class=astro-hlx5hkdr style=--depth:1><li class=astro-hlx5hkdr style=--depth:1><a href=#rewrite-urls-to-remove-unsupported-characters class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>Rewrite URLs to remove unsupported characters</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#proxy-rum-through-the-origin-to-avoid-a-tls-to-rum-service class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>Proxy RUM through the origin to avoid a TLS to rum service</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#shielding class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>Shielding</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#compression class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>Compression</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#failover class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>Failover</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#api-mesh-header-size-limit class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>API Mesh Header Size Limit</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#use-branch-names-on-staging class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>Use branch names on staging</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#maintainance-page-workaround class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>Maintainance page workaround</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#mulitple-setcookie-headers-issue class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>Mulitple setcookie headers issue</span></a></li></ul></li><li class=astro-hlx5hkdr style=--depth:0><a href=#commerce-configuration class=astro-hlx5hkdr style=--depth:0><span style=--depth:0 class=astro-hlx5hkdr>Commerce configuration</span></a></li><li class=astro-hlx5hkdr style=--depth:0><a href=#edge-delivery-service-configuration class=astro-hlx5hkdr style=--depth:0><span style=--depth:0 class=astro-hlx5hkdr>Edge Delivery Service configuration</span></a></li><li class=astro-hlx5hkdr style=--depth:0><a href=#validation class=astro-hlx5hkdr style=--depth:0><span style=--depth:0 class=astro-hlx5hkdr>Validation</span></a><ul class=astro-hlx5hkdr style=--depth:1><li class=astro-hlx5hkdr style=--depth:1><a href=#eds-content-encoding-surrogate-key-and-cache class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>EDS content encoding, surrogate key, and cache</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#eds-and-commerce-image-optimization class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>EDS and Commerce image optimization</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#commerce-cache class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>Commerce cache</span></a></li><li class=astro-hlx5hkdr style=--depth:1><a href=#commerce-base-url class=astro-hlx5hkdr style=--depth:1><span style=--depth:1 class=astro-hlx5hkdr>Commerce base URL</span></a></li></ul></li><li class=astro-hlx5hkdr style=--depth:0><a href=#debugging class=astro-hlx5hkdr style=--depth:0><span style=--depth:0 class=astro-hlx5hkdr>Debugging</span></a></li></ul></nav></starlight-toc></div><div class="astro-xbtg6jy7 sl-contribute"><h2 class=astro-xbtg6jy7>Contribute</h2><ul class="astro-xbtg6jy7 contribute"><li class=astro-xbtg6jy7><a href=https://github.com/commerce-docs/microsite-commerce-storefront/#readme class=astro-xbtg6jy7><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class=astro-xbtg6jy7 style=--sl-icon-size:1em height=16 width=16><path d="M21.17 2.06A13.1 13.1 0 0 0 19 1.87a12.94 12.94 0 0 0-7 2.05 12.94 12.94 0 0 0-7-2 13.1 13.1 0 0 0-2.17.19 1 1 0 0 0-.83 1v12a1 1 0 0 0 1.17 1 10.9 10.9 0 0 1 8.25 1.91l.12.07h.11a.91.91 0 0 0 .7 0h.11l.12-.07A10.899 10.899 0 0 1 20.83 16 1 1 0 0 0 22 15V3a1 1 0 0 0-.83-.94ZM11 15.35a12.87 12.87 0 0 0-6-1.48H4v-10c.333-.02.667-.02 1 0a10.86 10.86 0 0 1 6 1.8v9.68Zm9-1.44h-1a12.87 12.87 0 0 0-6 1.48V5.67a10.86 10.86 0 0 1 6-1.8c.333-.02.667-.02 1 0v10.04Zm1.17 4.15a13.098 13.098 0 0 0-2.17-.19 12.94 12.94 0 0 0-7 2.05 12.94 12.94 0 0 0-7-2.05c-.727.003-1.453.066-2.17.19A1 1 0 0 0 2 19.21a1 1 0 0 0 1.17.79 10.9 10.9 0 0 1 8.25 1.91 1 1 0 0 0 1.16 0A10.9 10.9 0 0 1 20.83 20a1 1 0 0 0 1.17-.79 1 1 0 0 0-.83-1.15Z" class=astro-xbtg6jy7></path></svg><span class=astro-xbtg6jy7>Contribute</span></a></li><li class=astro-xbtg6jy7><a href=https://github.com/commerce-docs/microsite-commerce-storefront/edit/develop/src/content/docs/implementation/setup/content-delivery-network.mdx class=astro-xbtg6jy7><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class=astro-xbtg6jy7 style=--sl-icon-size:1em height=16 width=16><path d="M22 7.24a1 1 0 0 0-.29-.71l-4.24-4.24a1 1 0 0 0-1.1-.22 1 1 0 0 0-.32.22l-2.83 2.83L2.29 16.05a1 1 0 0 0-.29.71V21a1 1 0 0 0 1 1h4.24a1 1 0 0 0 .76-.29l10.87-10.93L21.71 8c.1-.1.17-.2.22-.33a1 1 0 0 0 0-.24v-.14l.07-.05ZM6.83 20H4v-2.83l9.93-9.93 2.83 2.83L6.83 20ZM18.17 8.66l-2.83-2.83 1.42-1.41 2.82 2.82-1.41 1.42Z" class=astro-xbtg6jy7></path></svg><span class=astro-xbtg6jy7>Edit this page</span></a></li></ul></div></div></div></aside><div class="astro-dnpl4iv7 main-pane"><main class=astro-yjhsosxz data-pagefind-body dir=ltr lang=en><div class="astro-txjpuanv content-panel"><div class="astro-txjpuanv sl-container"><div class=astro-couag5ji><div class="astro-couag5ji group"></div><div class="title astro-couag5ji"><h1 class=astro-couag5ji id=_top>Content delivery network (CDN) setup</h1></div></div></div></div><div class="astro-txjpuanv content-panel"><div class="astro-txjpuanv sl-container"><starlight-image-zoom class=astro-ntxk7wqd data-hide-caption><template class=astro-ntxk7wqd><dialog class="astro-ntxk7wqd starlight-image-zoom-dialog"><button class="astro-ntxk7wqd starlight-image-zoom-control" aria-label="Unzoom image"><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class=astro-ntxk7wqd><use href=#starlight-image-zoom-icon-unzoom class=astro-ntxk7wqd></use></svg></button><figure class=astro-ntxk7wqd></figure></dialog></template><svg class=astro-ntxk7wqd style=display:none xmlns=http://www.w3.org/2000/svg><symbol class=astro-ntxk7wqd id=starlight-image-zoom-icon-zoom viewBox="0 0 24 24"><path d="M9.79 12.79 4 18.59V17a1 1 0 0 0-2 0v4a1 1 0 0 0 .08.38 1 1 0 0 0 .54.54A1 1 0 0 0 3 22h4a1 1 0 0 0 0-2H5.41l5.8-5.79a1 1 0 0 0-1.42-1.42ZM21.92 2.62a1 1 0 0 0-.54-.54A1 1 0 0 0 21 2h-4a1 1 0 0 0 0 2h1.59l-5.8 5.79a1 1 0 0 0 0 1.42 1 1 0 0 0 1.42 0L20 5.41V7a1 1 0 0 0 2 0V3a1 1 0 0 0-.08-.38Z" class=astro-ntxk7wqd></path></symbol><symbol class=astro-ntxk7wqd id=starlight-image-zoom-icon-unzoom viewBox="0 0 24 24"><path d="M21.71 2.29a1 1 0 0 0-1.42 0l-5.79 5.8V6.5a1 1 0 0 0-2 0v4a1 1 0 0 0 .08.38 1 1 0 0 0 .54.54 1 1 0 0 0 .38.08h4a1 1 0 0 0 0-2h-1.59l5.8-5.79a1 1 0 0 0 0-1.42ZM10.88 12.58a1 1 0 0 0-.38-.08h-4a1 1 0 0 0 0 2h1.59l-5.8 5.79a1 1 0 0 0 0 1.42 1 1 0 0 0 1.42 0l5.79-5.8v1.59a1 1 0 0 0 2 0v-4a1 1 0 0 0-.08-.38 1 1 0 0 0-.54-.54Z" class=astro-ntxk7wqd></path></symbol></svg></starlight-image-zoom><div class=sl-markdown-content><p>Decide early which CDN to use. A popular option is Fastly, which is included with your Adobe Commerce license.</p><p>This page provides instructions and guidance for configuring Adobe Commerce with Fastly. It focuses on routing use cases, configuration, validation, and debugging.</p><h2 id=configuration-blueprint>Configuration (blueprint)</h2><p>These are the key configurations required for a CDN setup:</p><ol class=sl-steps role=list><li><p>Configure a subdomain for development (e.g., <a href=http://aem.customer.com/ >aem.customer.com</a>).</p></li><li><p>Add/update the <code dir=auto>robots.txt</code> file to ensure that this site is not crawl-able by search engines.</p><p>Otherwise this may lead to <a href=https://ahrefs.com/blog/keyword-cannibalization/ >keyword cannibalisation</a>, which the site has to recover from post launch and may impact short-term top line.</p></li><li><p>Set up Edge Delivery Services CDN configuration according to the documentation.</p><p>For cache invalidation, a Fastly API key is required. This key can be requested from Adobe Commerce support team.</p></li><li><p>Validate that compression (<code dir=auto>gzip</code>) is working correctly.</p></li><li><p>Proxy certain paths back to Adobe Commerce.</p><p>This should be specific to your project, but generally you should at least proxy the following paths:</p><ul><li><p>Core GraphQL (e.g., <code dir=auto>https://customer-commerce/graphql</code> → <code dir=auto>/graphql</code>)</p><p>Ensure proper CORS headers are sent so that the endpoint can be accessed from <code dir=auto>hlx.page</code>, <code dir=auto>hlx.live</code>, and <code dir=auto>localhost:3000</code> hosts.</p></li><li><p>Catalog Service/Live Search endpoints</p><ul><li><strong>Production</strong>: <code dir=auto>https://catalog-service.adobe.io/graphql</code> → <code dir=auto>/cs-graphql</code></li><li><strong>Sandbox</strong>: <code dir=auto>https://catalog-service-sandbox.adobe.io/graphql</code> → <code dir=auto>/cs-graphql-sandbox</code></li><li>Remove all cookies from requests as Catalog Service has a relatively small HTTP header limit</li></ul></li><li><p>Product images coming from Adobe Commerce (e.g., <code dir=auto>/catalog/product/resized/200x200/3/_/3_1_1_12_2.jpeg</code>)</p></li><li><p>Additional paths required for Luma Bridge.</p></li></ul></li></ol><h2 id=cache-validation-blueprint>Cache validation (blueprint)</h2><p>It is critical that you validate that caching is working correctly. This should include requests with cookie headers and query parameters.</p><div class=expressive-code><link href=/microsite-commerce-storefront/_astro/ec.lt9oi.css rel=stylesheet><script src=/microsite-commerce-storefront/_astro/ec.8zarh.js type=module></script><figure class="frame not-content is-terminal"><figcaption class=header><span class=title></span><span class=sr-only>Terminal window</span></figcaption><pre data-language=bash><code><div class=ec-line><div class=code><span style=--0:#DCDCAA;--1:#6F42C1>curl</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#569CD6;--1:#005CC5>-sI</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#569CD6;--1:#005CC5>-H</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>'Fastly-Debug: 1'</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>https://www.bulk.com/uk/</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#D4D4D4;--1:#BF3441>|</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#DCDCAA;--1:#6F42C1>grep</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>x-cache</span></div></div><div class=ec-line><div class=code>
</div></div><div class=ec-line><div class=code><span style=--0:#DCDCAA;--1:#6F42C1>x-cache:</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>MISS,</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>HIT,</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>HIT,</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>HIT</span></div></div><div class=ec-line><div class=code><span style=--0:#DCDCAA;--1:#6F42C1>x-cache-hits:</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>0,</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>16,</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>102,</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#B5CEA8;--1:#005CC5>1</span></div></div></code></pre><div class=copy><button data-code="curl -sI -H &#x27;Fastly-Debug: 1&#x27; https://www.bulk.com/uk/ | grep x-cachex-cache: MISS, HIT, HIT, HITx-cache-hits: 0, 16, 102, 1" data-copied=Copied! title="Copy to clipboard"><div></div></button></div></figure></div><p>The <code dir=auto>x-cache</code> values are read right to left, where the right-most value represents your CDN (Commerce Fastly). This value should indicate a cache <code dir=auto>HIT</code>.</p><h2 id=surrogate-key-validation-blueprint>Surrogate key validation (blueprint)</h2><p>The default Adobe Commerce Fastly configuration overwrites surrogate keys set by Edge Delivery Services.</p><div class=expressive-code><figure class="frame not-content is-terminal"><figcaption class=header><span class=title></span><span class=sr-only>Terminal window</span></figcaption><pre data-language=bash><code><div class=ec-line><div class=code><span style=--0:#DCDCAA;--1:#6F42C1>curl</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#569CD6;--1:#005CC5>-sI</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#569CD6;--1:#005CC5>-H</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>'Fastly-Debug: 1'</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>https://www.bulk.com/uk/</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#D4D4D4;--1:#BF3441>|</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#DCDCAA;--1:#6F42C1>grep</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>surrogate-key</span></div></div><div class=ec-line><div class=code>
</div></div><div class=ec-line><div class=code><span style=--0:#DCDCAA;--1:#6F42C1>surrogate-key:</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>main--bul-eds--thepixel</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>401e079ea9d66cbdc48fc9bcd3a958206ef36cd2affcd6b672178e7628f</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>RKvjyvNRGjNtCHP3</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>401e079ea9d66cbdc48fc9bcd3a958206ef36cd2affcd6b672178e7628f_metadata</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>main--bul-eds--thepixel_head</span></div></div></code></pre><div class=copy><button data-code="curl -sI -H &#x27;Fastly-Debug: 1&#x27; https://www.bulk.com/uk/ | grep surrogate-keysurrogate-key: main--bul-eds--thepixel 401e079ea9d66cbdc48fc9bcd3a958206ef36cd2affcd6b672178e7628f RKvjyvNRGjNtCHP3 401e079ea9d66cbdc48fc9bcd3a958206ef36cd2affcd6b672178e7628f_metadata main--bul-eds--thepixel_head" data-copied=Copied! title="Copy to clipboard"><div></div></button></div></figure></div><p>When correctly set, the surrogate keys should include at least two <code dir=auto>ref-repo-org</code> references as indicated in the example above.</p><h2 id=routing-use-cases>Routing Use Cases</h2><p>Note: The main difference between the three use cases is the “default” routing logic—whether by default all paths are routed to Commerce or Edge Delivery. If a customer is only using EDS for the homepage, it makes more sense to default all paths to the Commerce origin. If a customer plans to migrate parts of the storefront over time with an eventual goal of being entirely served via Edge Delivery, then defaulting to Edge Delivery origins is more sensible.</p><p>That said, defaulting to Edge Delivery is generally more ideal when considering that users adding a new page in Edge Delivery would have to log in to Commerce Admin and understand Fastly VCLs to add the path for routing in the “default to Commerce” scenario. Therefore, the snippets below will focus on the “default to Edge” use cases.</p><h3 id=use-case-a-full-storefront>Use Case A: Full Storefront</h3><p>Full storefront is delivered by Edge Delivery Services. Only some paths, e.g. for images and API calls are routed to Commerce.</p><p>Customer example: Maidenform</p><p>Details:</p><p>By default, paths are routed to Edge Delivery Product images need to be routed to Commerce Core Magento Graphql endpoint needs to be routed to commerce CDN needs to proxy requests to catalog service endpoint (<a href=https://catalog-service.adobe.io/graphql>https://catalog-service.adobe.io/graphql</a> and <a href=https://catalog-service-sandbox.adobe.io/graphql>https://catalog-service-sandbox.adobe.io/graphql</a>). These API endpoints impact LCP, so we want to avoid an additional TLS handshake. This optimization has already been applied to the Boilerplate, where we use a “custom” version of the LS Widget to change the API url used by the widget.</p><h3 id=use-case-b-luma-bridge>Use Case B: Luma Bridge</h3><p>Product catalog and content pages are delivered by Edge Delivery. Transactional pages like cart, checkout and account are delivered by Commerce.</p><p>Customer example: Bulk, Sony, Champion, Wilson, Dolce Gusto (Phase 2)</p><p>Details:</p><p>Same applies as use case A, and additionally: Pages (like cart page, checkout page, account page) are routed to Commerce, depending on the Luma Bridge implementation Any additional endpoints (eg. REST endpoints, /customer/sections/load) that are required by the Luma Bridge are routed to commerce. Details of the different Luma Bridge implementations can be found at Luma bridge</p><h3 id=use-case-c-homepage-only>Use Case C: Homepage only</h3><p>Only the homepage is delivered by Edge Delivery. All Commerce functionality is delivered by Commerce.</p><p>Customer example: Dolce Gusto (Phase 1), Visual Comfort</p><p>Details:</p><p>All paths are routed to Commerce by default The paths that are routed to Edge Delivery are explicitly set Additionally, resources (js, css) that are required by the Edge Delivery pages need to be routed to Edge Delivery. One common pattern is to move all Edge Delivery code into a sub-folder called aem, and then route any path starting with aem to edge delivery</p><p>For general information on setting up fastly for commerce and accessing the Admin UI, see the docs at <a href=https://experienceleague.adobe.com/en/docs/commerce-cloud-service/user-guide/cdn/fastly>https://experienceleague.adobe.com/en/docs/commerce-cloud-service/user-guide/cdn/fastly</a>.</p><h2 id=backend-configuration>Backend configuration</h2><p>The first step of the configuration is to configure a backend for each origin/service that Fastly needs to route to. Typically this would be catalog service graphql and Edge Delivery Services in addition to the default commerce backend.</p><p>The following screenshot shows the configuration for the Edge Delivery Service. Make sure the following is set:</p><p>Condition: We will handle conditional routing in the VCL scripts. Set the condition to false (REQUEST) false for all backends - do not forget to set this condition also for the default backend, otherwise this can overwrite the changes made by your VCL conditions that are configured in the snippets. Shielding: If you are using shielding, please see the section below on shielding. Recommendation is to keep this off for simplicity. In addition to the Edge Delivery backend, please do the same for Catalog Service endpoints <a href=https://catalog-service.adobe.io/graphql>https://catalog-service.adobe.io/graphql</a> and <a href=https://catalog-service-sandbox.adobe.io/graphql>https://catalog-service-sandbox.adobe.io/graphql</a>, as well as any other backends you may require.</p><p>You can also rename the Commerce backend from the generated name to simply commerce.</p><p><starlight-image-zoom-zoomable><img alt="Backend configuration for Edge Delivery Services" height=632 src=/microsite-commerce-storefront/_astro/backend-config-edge.FhgWGNJ__Z2mY50N.webp width=1770 data-image-component=true decoding=async loading=lazy><button class=starlight-image-zoom-control aria-label="Zoom image: Backend configuration for Edge Delivery Services"><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true><use href=#starlight-image-zoom-icon-zoom></use></svg></button></starlight-image-zoom-zoomable></p><p><starlight-image-zoom-zoomable><img alt="Backend configuration for Commerce" height=319 src=/microsite-commerce-storefront/_astro/backend-config-commerce.CX9-CM7R_mOMjq.webp width=787 data-image-component=true decoding=async loading=lazy><button class=starlight-image-zoom-control aria-label="Zoom image: Backend configuration for Commerce"><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true><use href=#starlight-image-zoom-icon-zoom></use></svg></button></starlight-image-zoom-zoomable></p><h2 id=vcl-configuration>VCL configuration</h2><p>Setting up routing will typically require 5 snippets: recv, pass, miss, fetch and deliver.</p><p>Please follow <a href=https://experienceleague.adobe.com/en/docs/commerce-cloud-service/user-guide/cdn/custom-vcl-snippets/fastly-vcl-custom-snippets>https://experienceleague.adobe.com/en/docs/commerce-cloud-service/user-guide/cdn/custom-vcl-snippets/fastly-vcl-custom-snippets</a>, or use the Fastly Admin module UI to apply the custom VCL snippets below to your Adobe Commerce Fastly CDN service.</p><p>The following VCL snippets are starting points and can be altered or extended to fit your use cases. There are also examples of potential extended use cases listed further down on the page.</p><p>The main purposes of the VCL snippets are:</p><p>Correctly setting the backend based on request path Ensuring the requests do not receive extra caching or headers if they are going to a non-magento backend, achieved by returning early Improve performance for non-magento backends - this means re-writing some features like compression, that would be provided by the default magento VCL OOTB, but was skipped because we don’t want to run the full commerce default VCL !! If you make a change or apply a new VCL snippet, it can take some time to propagate and apply to Fastly’s system. Best practice is to validate latest change before continuing to other changes, otherwise you may introduce a bug and find it challenging to determine the root cause.</p><p>!! If you need to rename a snippet, delete it first and then recreate it with the new name. <a href=https://github.com/fastly/fastly-magento2/issues/708>https://github.com/fastly/fastly-magento2/issues/708</a></p><p><starlight-image-zoom-zoomable><img alt="VCL configuration" height=648 src=/microsite-commerce-storefront/_astro/vcl-config.Bq5GKn9X_1SLXQF.webp width=1164 data-image-component=true decoding=async loading=lazy><button class=starlight-image-zoom-control aria-label="Zoom image: VCL configuration"><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true><use href=#starlight-image-zoom-icon-zoom></use></svg></button></starlight-image-zoom-zoomable></p><p>From <a href=https://www.fastly.com/documentation/guides/vcl/using/ >https://www.fastly.com/documentation/guides/vcl/using/</a></p><h3 id=recv>recv</h3><p>Type: recv</p><p>Priority: 4</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header></figcaption><pre data-language=txt><code><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>if (req.http.host == "aemshop.net") {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>  </span></span><span style=--0:#d4d4d4;--1:#24292e>set req.http.host = "www.aemshop.net";</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>  </span></span><span style=--0:#d4d4d4;--1:#24292e>error 801;</span></div></div><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>}</span></div></div></code></pre><div class=copy><button data-code="if (req.http.host == &#x22;aemshop.net&#x22;) {  set req.http.host = &#x22;www.aemshop.net&#x22;;  error 801;}" data-copied=Copied! title="Copy to clipboard"><div></div></button></div></figure></div><p>This snippet does a simple redirect, if host does not contain www, it adds it, and then it redirects to https using a Fastly-specific error code.</p><p>Type: recv</p><p>Priority: 100</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header></figcaption><pre data-language=txt><code><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>unset req.http.x-commerce;</span></div></div><div class=ec-line><div class=code>
</div></div><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e># Catalog Service</span></div></div><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>if (req.url.path ~ "^/cs-graphql$") {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e># Disable Commerce WAF as it can interfere with some queries</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set req.http.bypasswaf = "true";</span></div></div><div class=ec-line><div class=code>
</div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e># Forward to Catalog Service GraphQL</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set req.backend = F_catalog_service;</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set req.http.host = "catalog-service.adobe.io";</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set req.url = regsub(req.url, "^/cs-graphql", "/graphql");</span></div></div><div class=ec-line><div class=code>
</div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e># Remove cookies</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>unset req.http.Cookie;</span></div></div><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>}</span></div></div><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>else if (req.url.path ~ "^/(graphql|rest|oauth|media|checkout|customer|admin|static)($|/)") {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e># Commerce routes, e.g. for product images, core GQL/Rest, Luma Bridge (any paths which should load Commerce origin)</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set req.backend = F_commerce;</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set req.http.x-commerce = "true";</span></div></div><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>}</span></div></div><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>else</span></div></div><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>{</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e># Block access to non-prod configs</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>if (req.url ~ "configs-stage.json" || req.url ~ "configs-dev.json") {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>        </span></span><span style=--0:#d4d4d4;--1:#24292e>error 404 "Not Found";</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>}</span></div></div><div class=ec-line><div class=code>
</div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e># Everything else is considered Edge Delivery Services</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set req.backend = F_edge_delivery;</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e># Restore accepted encoding</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set req.http.Accept-Encoding = req.http.Fastly-Orig-Accept-Encoding;</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>if (req.url.path !~ "/media_[0-9a-f]{40,}[/a-zA-Z0-9_-]*\.[0-9a-z]+$"</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>        </span></span><span style=--0:#d4d4d4;--1:#24292e>&#x26;&#x26; req.url.ext !~ "(?i)^(gif|png|jpe?g|webp)$"</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>        </span></span><span style=--0:#d4d4d4;--1:#24292e>&#x26;&#x26; req.url.ext != "json"</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>        </span></span><span style=--0:#d4d4d4;--1:#24292e>&#x26;&#x26; req.url.path != "/.auth") {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>        </span></span><span style=--0:#d4d4d4;--1:#24292e># trim the query string to improve caching</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>        </span></span><span style=--0:#d4d4d4;--1:#24292e>set req.url = req.url.path;</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>        </span></span><span style=--0:#d4d4d4;--1:#24292e># replace some special characters with a dash because Edge doesn't support them</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>        </span></span><span style=--0:#d4d4d4;--1:#24292e>set req.url = regsuball(req.url, "[()]", "-");</span></div></div><div class=ec-line><div class=code>
</div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>}</span></div></div><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>}</span></div></div></code></pre><div class=copy><button data-code="unset req.http.x-commerce;# Catalog Serviceif (req.url.path ~ &#x22;^/cs-graphql$&#x22;) {    # Disable Commerce WAF as it can interfere with some queries    set req.http.bypasswaf = &#x22;true&#x22;;    # Forward to Catalog Service GraphQL    set req.backend = F_catalog_service;    set req.http.host = &#x22;catalog-service.adobe.io&#x22;;    set req.url = regsub(req.url, &#x22;^/cs-graphql&#x22;, &#x22;/graphql&#x22;);    # Remove cookies    unset req.http.Cookie;}else if (req.url.path ~ &#x22;^/(graphql|rest|oauth|media|checkout|customer|admin|static)($|/)&#x22;) {    # Commerce routes, e.g. for product images, core GQL/Rest, Luma Bridge (any paths which should load Commerce origin)    set req.backend = F_commerce;    set req.http.x-commerce = &#x22;true&#x22;;}else{    # Block access to non-prod configs    if (req.url ~ &#x22;configs-stage.json&#x22; || req.url ~ &#x22;configs-dev.json&#x22;) {        error 404 &#x22;Not Found&#x22;;    }    # Everything else is considered Edge Delivery Services    set req.backend = F_edge_delivery;    # Restore accepted encoding    set req.http.Accept-Encoding = req.http.Fastly-Orig-Accept-Encoding;    if (req.url.path !~ &#x22;/media_[0-9a-f]{40,}[/a-zA-Z0-9_-]*\.[0-9a-z]+$&#x22;        &#x26;&#x26; req.url.ext !~ &#x22;(?i)^(gif|png|jpe?g|webp)$&#x22;        &#x26;&#x26; req.url.ext != &#x22;json&#x22;        &#x26;&#x26; req.url.path != &#x22;/.auth&#x22;) {        # trim the query string to improve caching        set req.url = req.url.path;        # replace some special characters with a dash because Edge doesn&#x27;t support them        set req.url = regsuball(req.url, &#x22;[()]&#x22;, &#x22;-&#x22;);    }}" data-copied=Copied! title="Copy to clipboard"><div></div></button></div></figure></div><p>The recv snippet has the following purpose:</p><ul><li>Path based routing: EDS, Catalog Service or Adobe Commerce backends</li><li>Preparing the requests for the respective backends.</li></ul><h3 id=pass>pass</h3><p>Type: pass</p><p>Priority: 30</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header></figcaption><pre data-language=txt><code><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>if (req.backend == F_edge_delivery) {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set bereq.http.Host = "main--aem-boilerplate-commerce--hlxsites.hlx.live";</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set bereq.http.X-BYO-CDN-Type = "fastly";</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set bereq.http.X-Push-Invalidation = "enabled";</span></div></div><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>}</span></div></div><div class=ec-line><div class=code>
</div></div><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>if (req.backend == F_commerce) {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set bereq.http.Host = "mcprod.aemshop.net";</span></div></div><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>}</span></div></div><div class=ec-line><div class=code>
</div></div><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>if (!req.http.x-commerce) {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>return(pass);</span></div></div><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>}</span></div></div></code></pre><div class=copy><button data-code="if (req.backend == F_edge_delivery) {    set bereq.http.Host = &#x22;main--aem-boilerplate-commerce--hlxsites.hlx.live&#x22;;    set bereq.http.X-BYO-CDN-Type = &#x22;fastly&#x22;;    set bereq.http.X-Push-Invalidation = &#x22;enabled&#x22;;}if (req.backend == F_commerce) {    set bereq.http.Host = &#x22;mcprod.aemshop.net&#x22;;}if (!req.http.x-commerce) {    return(pass);}" data-copied=Copied! title="Copy to clipboard"><div></div></button></div></figure></div><p>!! Changes to the Host header set here will require a Commerce Fastly cache purge due to how and when Fastly calculates cache HITS.</p><p>In the pass snippet, we set the correct host url to fetch from depending on the backend that was selected in recv.</p><p>If it’s not a request to commerce, we skip (return pass will invoke fetch) the rest of the default pass VCL, although this may not be really necessary: <a href=https://github.com/fastly/fastly-magento2/blob/fdd616cd0f945530e02e92e594ca00fd7990f557/etc/vcl_snippets/pass.vcl>https://github.com/fastly/fastly-magento2/blob/fdd616cd0f945530e02e92e594ca00fd7990f557/etc/vcl_snippets/pass.vcl</a></p><h3 id=miss>miss</h3><p>Type: miss</p><p>Priority: 30</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header></figcaption><pre data-language=txt><code><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>if (req.backend == F_edge_delivery) {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set bereq.http.Host = "main--aem-boilerplate-commerce--hlxsites.hlx.live";</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set bereq.http.X-BYO-CDN-Type = "fastly";</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set bereq.http.X-Push-Invalidation = "enabled";</span></div></div><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>}</span></div></div><div class=ec-line><div class=code>
</div></div><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>if (req.backend == F_commerce) {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set bereq.http.Host = "mcprod.aemshop.net";</span></div></div><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>}</span></div></div><div class=ec-line><div class=code>
</div></div><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>if (!req.http.x-commerce) {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>return(fetch);</span></div></div><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>}</span></div></div></code></pre><div class=copy><button data-code="if (req.backend == F_edge_delivery) {    set bereq.http.Host = &#x22;main--aem-boilerplate-commerce--hlxsites.hlx.live&#x22;;    set bereq.http.X-BYO-CDN-Type = &#x22;fastly&#x22;;    set bereq.http.X-Push-Invalidation = &#x22;enabled&#x22;;}if (req.backend == F_commerce) {    set bereq.http.Host = &#x22;mcprod.aemshop.net&#x22;;}if (!req.http.x-commerce) {    return(fetch);}" data-copied=Copied! title="Copy to clipboard"><div></div></button></div></figure></div><p>!! Changes to the Host header set here will require a Commerce Fastly cache purge due to how and when Fastly calculates cache HITS.</p><p>Same as pass.</p><h3 id=fetch>fetch</h3><p>Type: fetch</p><p>Priority: 30</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header></figcaption><pre data-language=txt><code><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>if (!req.http.x-commerce) {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>unset beresp.http.Set-Cookie;</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>return(deliver);</span></div></div><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>}</span></div></div></code></pre><div class=copy><button data-code="if (!req.http.x-commerce) {    unset beresp.http.Set-Cookie;    return(deliver);}" data-copied=Copied! title="Copy to clipboard"><div></div></button></div></figure></div><p>If fetching from a backend other than commerce, we skip the rest of the default deliver VCL at <a href=https://github.com/fastly/fastly-magento2/blob/fdd616cd0f945530e02e92e594ca00fd7990f557/etc/vcl_snippets/fetch.vcl>https://github.com/fastly/fastly-magento2/blob/fdd616cd0f945530e02e92e594ca00fd7990f557/etc/vcl_snippets/fetch.vcl</a> because this is only relevant to the magento backends</p><h3 id=deliver>deliver</h3><p>Type: deliver</p><p>Priority: 30</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header></figcaption><pre data-language=txt><code><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>if (req.backend == F_edge_delivery) {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>unset resp.http.Age;</span></div></div><div class=ec-line><div class=code>
</div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>if (req.url.path !~ "\.plain\.html$") {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>        </span></span><span style=--0:#d4d4d4;--1:#24292e>unset resp.http.X-Robots-Tag;</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>}</span></div></div><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>}</span></div></div></code></pre><div class=copy><button data-code="if (req.backend == F_edge_delivery) {    unset resp.http.Age;    if (req.url.path !~ &#x22;\.plain\.html$&#x22;) {        unset resp.http.X-Robots-Tag;    }}" data-copied=Copied! title="Copy to clipboard"><div></div></button></div></figure></div><p>This comes from <a href="https://www.aem.live/docs/byo-cdn-fastly-setup#:~:text=Finally%20create%20a%20deliver%20snippet">https://www.aem.live/docs/byo-cdn-fastly-setup#:~:text=Finally%20create%20a%20deliver%20snippet</a></p><h2 id=optional-configuration>Optional configuration</h2><h3 id=rewrite-urls-to-remove-unsupported-characters>Rewrite URLs to remove unsupported characters</h3><p>Be aware that URLs in Edge Delivery may only contain a-z, 0-9 and the dash (’-’) character (see <a href=https://www.aem.live/docs/limits#document-naming>https://www.aem.live/docs/limits#document-naming</a>). Be aware that you may need to create a CDN rule to rewrite/remove these characters.</p><p>As an example, consider one possible case where this applies with login referrer links: Luma may redirect to a page like <code dir=auto>/login/referrer/&#x3C;base64string></code> . If the login page is implemented in Edge Delivery (via Luma Bridge), and the base 64 string contains unsupported characters, this page will 404. Since the base64 part is only needed on the Edge Delivery client side to handle redirecting after a successful sign-in, this could be stripped for the request to the Edge Delivery backend.</p><p>The exact cases where this needs to be performed, and the steps required, will depend on the implementation of the Luma bridge as well as customizations of Adobe Commerce.</p><h3 id=proxy-rum-through-the-origin-to-avoid-a-tls-to-rum-service>Proxy RUM through the origin to avoid a TLS to rum service</h3><p>Add to recv:</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header></figcaption><pre data-language=txt><code><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>if (req.url.path ~ "^/\.rum/") {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e># AEM Real User Monitoring</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set req.backend = F_hlx_rum;</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>unset req.http.Cookie;</span></div></div><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>}</span></div></div></code></pre><div class=copy><button data-code="if (req.url.path ~ &#x22;^/\.rum/&#x22;) {    # AEM Real User Monitoring    set req.backend = F_hlx_rum;    unset req.http.Cookie;}" data-copied=Copied! title="Copy to clipboard"><div></div></button></div></figure></div><p>Add a new backend called hlx_rum that points to rum.hlx.page. Also change the rum implementation in aem.js to use a relative path to the origin instead of rum.hlx.page.</p><h3 id=shielding>Shielding</h3><p>If you enable shielding in a backend, then conditions like req.backend == F_commerce may not work. For this reason, the snippets above use a header like http.x-commerce that is set/unset, which is then used instead of the direct backend variable.</p><h3 id=compression>Compression</h3><p>In fetch, you can add compression for non-commerce resources by adding this snippet to the fetch VCL:</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header></figcaption><pre data-language=txt><code><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>if (!req.http.x-commerce) {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>unset beresp.http.Set-Cookie;</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>if (beresp.http.content-type ~ "(text/|/json|/javascript)") {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>        </span></span><span style=--0:#d4d4d4;--1:#24292e>if (!beresp.http.Vary ~ "Accept-Encoding") {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>            </span></span><span style=--0:#d4d4d4;--1:#24292e>set beresp.http.Vary:Accept-Encoding = "";</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>        </span></span><span style=--0:#d4d4d4;--1:#24292e>}</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>        </span></span><span style=--0:#d4d4d4;--1:#24292e>if (req.http.Accept-Encoding == "br") {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>            </span></span><span style=--0:#d4d4d4;--1:#24292e>set beresp.brotli = true;</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>        </span></span><span style=--0:#d4d4d4;--1:#24292e>} else if (req.http.Accept-Encoding == "gzip") {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>            </span></span><span style=--0:#d4d4d4;--1:#24292e>set beresp.gzip = true;</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>        </span></span><span style=--0:#d4d4d4;--1:#24292e>}</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>}</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>return(deliver);</span></div></div><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>}</span></div></div></code></pre><div class=copy><button data-code="if (!req.http.x-commerce) {    unset beresp.http.Set-Cookie;    if (beresp.http.content-type ~ &#x22;(text/|/json|/javascript)&#x22;) {        if (!beresp.http.Vary ~ &#x22;Accept-Encoding&#x22;) {            set beresp.http.Vary:Accept-Encoding = &#x22;&#x22;;        }        if (req.http.Accept-Encoding == &#x22;br&#x22;) {            set beresp.brotli = true;        } else if (req.http.Accept-Encoding == &#x22;gzip&#x22;) {            set beresp.gzip = true;        }    }    return(deliver);}" data-copied=Copied! title="Copy to clipboard"><div></div></button></div></figure></div><p>Since deliver skips all the subsequent steps, the default compression settings are skipped. This code above is the same as in the default VCL, but copied again to be applied to responses that are not going to the commerce backend.</p><h3 id=failover>Failover</h3><p>We can support automatic failover from Edge Delivery to Commerce Luma pages on a 404 in Edge Delivery. To do this, in your custom fetch snippet add:</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header></figcaption><pre data-language=txt><code><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>if (req.backend == F_edge &#x26;&#x26; http_status_matches(beresp.status, "404")) {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>      </span></span><span style=--0:#d4d4d4;--1:#24292e># See &#x3C;https://www.fastly.com/documentation/solutions/examples/failover-to-a-secondary-backend/></span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>      </span></span><span style=--0:#d4d4d4;--1:#24292e>set beresp.http.Vary:restarts = ""; # Add restart to vary key</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>      </span></span><span style=--0:#d4d4d4;--1:#24292e>set beresp.cacheable = true; # Errors are not cacheable by default, so enable them</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>      </span></span><span style=--0:#d4d4d4;--1:#24292e>set beresp.ttl = 5s; # Set a short ttl so the unfindable object expires quickly</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>      </span></span><span style=--0:#d4d4d4;--1:#24292e>set beresp.http.do_failover = "yes";</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>   </span></span><span style=--0:#d4d4d4;--1:#24292e>}</span></div></div></code></pre><div class=copy><button data-code="if (req.backend == F_edge &#x26;&#x26; http_status_matches(beresp.status, &#x22;404&#x22;)) {      # See <https://www.fastly.com/documentation/solutions/examples/failover-to-a-secondary-backend/>      set beresp.http.Vary:restarts = &#x22;&#x22;; # Add restart to vary key      set beresp.cacheable = true; # Errors are not cacheable by default, so enable them      set beresp.ttl = 5s; # Set a short ttl so the unfindable object expires quickly      set beresp.http.do_failover = &#x22;yes&#x22;;   }" data-copied=Copied! title="Copy to clipboard"><div></div></button></div></figure></div><p>Then in your custom recv snippet, we need to set:</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header></figcaption><pre data-language=txt><code><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>if (req.http.try-alt-origin) {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set req.backend = F_commerce;</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set req.http.x-commerce = "true";</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set req.http.restarts = req.restarts; # Use restart value for vary key</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set req.http.Fastly-Force-Shield = "1";</span></div></div><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>}</span></div></div></code></pre><div class=copy><button data-code="if (req.http.try-alt-origin) {    set req.backend = F_commerce;    set req.http.x-commerce = &#x22;true&#x22;;    set req.http.restarts = req.restarts; # Use restart value for vary key    set req.http.Fastly-Force-Shield = &#x22;1&#x22;;}" data-copied=Copied! title="Copy to clipboard"><div></div></button></div></figure></div><p>Factly-Force-Shield may be required to turn on clustering (note: not related to shielding despite the name).</p><p>Flow of EDS request: In recv, hits EDS case, then goes to miss, then goes to fetch, fetch returns 404 and sets retry (as snippet above), and deliver calls restart.</p><p>If we are using fastly shielding, we need to have fastly.ff.visits_this_service == 0 in the deliver snippet, before restart, otherwise it can be that ESI doesn’t work.</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header></figcaption><pre data-language=txt><code><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>if (fastly.ff.visits_this_service == 0 &#x26;&#x26; !req.http.try-alt-origin &#x26;&#x26; resp.http.do_failover == "yes") {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set req.http.try-alt-origin = "1";</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set req.url = req.http.Magento-Original-URL;</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>return (restart);</span></div></div><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>}</span></div></div></code></pre><div class=copy><button data-code="if (fastly.ff.visits_this_service == 0 &#x26;&#x26; !req.http.try-alt-origin &#x26;&#x26; resp.http.do_failover == &#x22;yes&#x22;) {    set req.http.try-alt-origin = &#x22;1&#x22;;    set req.url = req.http.Magento-Original-URL;    return (restart);}" data-copied=Copied! title="Copy to clipboard"><div></div></button></div></figure></div><p>It is not recommended to handle all paths that need to be routed to luma like this, but still hardcode those that are known, in order to reduce load of 404s on edge delivery.</p><h3 id=api-mesh-header-size-limit>API Mesh Header Size Limit</h3><p>API mesh has a header size limit. We may need to remove third party cookies if using API mesh:</p><p>Header size limit. We need to remove custom cookies. Add this in the graphql section of recv:</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header></figcaption><pre data-language=txt><code><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>if (req.http.Cookie) {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>        </span></span><span style=--0:#d4d4d4;--1:#24292e># Remove all 3rd-party cookies</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>        </span></span><span style=--0:#d4d4d4;--1:#24292e># API Mesh has a header size limit</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>        </span></span><span style=--0:#d4d4d4;--1:#24292e>set req.http.Cookie = ";" + req.http.Cookie;</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>        </span></span><span style=--0:#d4d4d4;--1:#24292e>set req.http.Cookie = regsuball(req.http.Cookie, "; +", ";");</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>        </span></span><span style=--0:#d4d4d4;--1:#24292e>set req.http.Cookie = regsuball(req.http.Cookie, ";(PHPSESSID|X-Magento-Vary|form_key|private_content_version|mage-messages|persistent_shopping_cart|fastly_geo_store)=", "; \\1=");</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>        </span></span><span style=--0:#d4d4d4;--1:#24292e>set req.http.Cookie = regsuball(req.http.Cookie, ";[^ ][^;]*", "");</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>        </span></span><span style=--0:#d4d4d4;--1:#24292e>set req.http.Cookie = regsuball(req.http.Cookie, "^[; ]+|[; ]+$", "");</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>        </span></span><span style=--0:#d4d4d4;--1:#24292e>if (req.http.cookie ~ "^\\s*$") {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>            </span></span><span style=--0:#d4d4d4;--1:#24292e>unset req.http.cookie;</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>        </span></span><span style=--0:#d4d4d4;--1:#24292e>}</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>}</span></div></div></code></pre><div class=copy><button data-code="if (req.http.Cookie) {        # Remove all 3rd-party cookies        # API Mesh has a header size limit        set req.http.Cookie = &#x22;;&#x22; + req.http.Cookie;        set req.http.Cookie = regsuball(req.http.Cookie, &#x22;; +&#x22;, &#x22;;&#x22;);        set req.http.Cookie = regsuball(req.http.Cookie, &#x22;;(PHPSESSID|X-Magento-Vary|form_key|private_content_version|mage-messages|persistent_shopping_cart|fastly_geo_store)=&#x22;, &#x22;; \\1=&#x22;);        set req.http.Cookie = regsuball(req.http.Cookie, &#x22;;[^ ][^;]*&#x22;, &#x22;&#x22;);        set req.http.Cookie = regsuball(req.http.Cookie, &#x22;^[; ]+|[; ]+$&#x22;, &#x22;&#x22;);        if (req.http.cookie ~ &#x22;^\\s*$&#x22;) {            unset req.http.cookie;        }    }" data-copied=Copied! title="Copy to clipboard"><div></div></button></div></figure></div><h3 id=use-branch-names-on-staging>Use branch names on staging</h3><p>We can enable using Edge Delivery branches on a staging url (eg. branch1.my-staging.com):</p><p>Use regex to get domain name, add this snippet to the miss snippet:</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header></figcaption><pre data-language=txt><code><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>if (req.backend == F_edge) {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>if (req.http.Host ~ "^([^.]+)\\.([^.]+)\\.lovesac\\.com$") {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>        </span></span><span style=--0:#d4d4d4;--1:#24292e>set bereq.http.Host = re.group.1 + "--your-eds-url.hlx.page";</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>} else {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>        </span></span><span style=--0:#d4d4d4;--1:#24292e>set bereq.http.Host = "your-eds-url.hlx.live";</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>}</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set bereq.http.X-BYO-CDN-Type = "fastly";</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set bereq.http.X-Push-Invalidation = "enabled";</span></div></div><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>}</span></div></div></code></pre><div class=copy><button data-code="if (req.backend == F_edge) {    if (req.http.Host ~ &#x22;^([^.]+)\\.([^.]+)\\.lovesac\\.com$&#x22;) {        set bereq.http.Host = re.group.1 + &#x22;--your-eds-url.hlx.page&#x22;;    } else {        set bereq.http.Host = &#x22;your-eds-url.hlx.live&#x22;;    }    set bereq.http.X-BYO-CDN-Type = &#x22;fastly&#x22;;    set bereq.http.X-Push-Invalidation = &#x22;enabled&#x22;;}" data-copied=Copied! title="Copy to clipboard"><div></div></button></div></figure></div><p>In the domains config, you need to put a wildcard. The admin UI doesn’t let you do this however. So you need to do it using the fastly CLI, which works (and also shows the wildcard url in the Admin UI).</p><h3 id=maintainance-page-workaround>Maintainance page workaround</h3><p>The maintainance page can block requests to API mesh/graphql. The solution is to create a VCL with low priority that comes before the maintainance check in VCL, that allows graphql through. (set commerce backend and pass)</p><h3 id=mulitple-setcookie-headers-issue>Mulitple setcookie headers issue</h3><p>Mutliple set cookie headers bug in api mesh: Probably fixed in product now, but this workaround fixed it in the meantime:</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header></figcaption><pre data-language=txt><code><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>if (req.http.x-mesh == "true") {</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e># There's a bug in API MESH that combines multiple set-cookie headers</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e># Let's remove these cookies from the response</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>declare local var.ignored BOOL;</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set var.ignored = setcookie.delete_by_name(beresp, "private_content_version");</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set var.ignored = setcookie.delete_by_name(beresp, "form_key");</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set var.ignored = setcookie.delete_by_name(beresp, "authentication_flag");</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set var.ignored = setcookie.delete_by_name(beresp, "dataservices_customer_id");</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set var.ignored = setcookie.delete_by_name(beresp, "dataservices_customer_group");</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>set var.ignored = setcookie.delete_by_name(beresp, "dataservices_cart_id");</span></div></div><div class=ec-line><div class=code><span class=indent><span style=--0:#d4d4d4;--1:#24292e>    </span></span><span style=--0:#d4d4d4;--1:#24292e>return (pass);</span></div></div><div class=ec-line><div class=code><span style=--0:#d4d4d4;--1:#24292e>}</span></div></div></code></pre><div class=copy><button data-code="if (req.http.x-mesh == &#x22;true&#x22;) {    # There&#x27;s a bug in API MESH that combines multiple set-cookie headers    # Let&#x27;s remove these cookies from the response    declare local var.ignored BOOL;    set var.ignored = setcookie.delete_by_name(beresp, &#x22;private_content_version&#x22;);    set var.ignored = setcookie.delete_by_name(beresp, &#x22;form_key&#x22;);    set var.ignored = setcookie.delete_by_name(beresp, &#x22;authentication_flag&#x22;);    set var.ignored = setcookie.delete_by_name(beresp, &#x22;dataservices_customer_id&#x22;);    set var.ignored = setcookie.delete_by_name(beresp, &#x22;dataservices_customer_group&#x22;);    set var.ignored = setcookie.delete_by_name(beresp, &#x22;dataservices_cart_id&#x22;);    return (pass);}" data-copied=Copied! title="Copy to clipboard"><div></div></button></div></figure></div><p>Note: x-mesh header is just example, it would be added in API mesh to use as determination in routing of VCL. Lovesac called this “x-commerce-bypass-fastly-cache”.</p><h2 id=commerce-configuration>Commerce configuration</h2><p>In the Adobe Commerce backend, assuming you are using the VCL to do the apex redirect (ie aemshop.net → <a href=http://www.aemshop.net>www.aemshop.net</a> with 801 error), you should do two things:</p><ol><li>Disable “auto-redirect”.</li><li>Set the base_url and secure_base_url settings to your domain, including <a href=http://www>www</a>.</li></ol><p><starlight-image-zoom-zoomable><img alt="Commerce configuration" height=746 src=/microsite-commerce-storefront/_astro/commerce-config.Cr2vPLta_Z2i6tVH.webp width=2296 data-image-component=true decoding=async loading=lazy><button class=starlight-image-zoom-control aria-label="Zoom image: Commerce configuration"><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true><use href=#starlight-image-zoom-icon-zoom></use></svg></button></starlight-image-zoom-zoomable></p><h2 id=edge-delivery-service-configuration>Edge Delivery Service configuration</h2><p>To obtain a purge API token for Fastly, please reach out to Adobe Commerce customer support via <a href=https://support.magento.com/ >https://support.magento.com/</a>.</p><p>Then follow the “Setup push invalidation for Fastly” section on <a href=https://www.aem.live/docs/byo-cdn-fastly-setup#setup-push-invalidation-for-fastly>https://www.aem.live/docs/byo-cdn-fastly-setup#setup-push-invalidation-for-fastly</a>. The remaining configuration described in the document is already taken care of by applying the VCLs above.</p><h2 id=validation>Validation</h2><p>To validate your CDN setup, use curl requests to check expected responses from the paths you have configured.</p><h3 id=eds-content-encoding-surrogate-key-and-cache>EDS content encoding, surrogate key, and cache</h3><p>Validate that surrogate-key, cache hits, and content encoding are working as expected by requesting an EDS served asset from your Commerce domain. Ensure you are checking a warm cache by making the request at least twice. The following examples are to a warmed cache.</p><p>Here is an example of validation against our staging environment.</p><div class=expressive-code><figure class="frame not-content is-terminal"><figcaption class=header><span class=title></span><span class=sr-only>Terminal window</span></figcaption><pre data-language=bash><code><div class=ec-line><div class=code><span style=--0:#DCDCAA;--1:#6F42C1>curl</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#569CD6;--1:#005CC5>-sI</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#569CD6;--1:#005CC5>-H</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>'Fastly-Debug: 1'</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>https://aemshop.net/scripts/aem.js</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#D4D4D4;--1:#BF3441>|</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#DCDCAA;--1:#6F42C1>grep</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>'x-cache\|surrogate-key\|cache-control'</span></div></div><div class=ec-line><div class=code><span style=--0:#DCDCAA;--1:#6F42C1>content-encoding:</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>gzip</span></div></div><div class=ec-line><div class=code><span style=--0:#DCDCAA;--1:#6F42C1>surrogate-key:</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>develop--aem-boilerplate-commerce--hlxsites</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>develop--aem-boilerplate-commerce--hlxsites_code</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>E3hjdgev7F5OyPUD</span></div></div><div class=ec-line><div class=code><span style=--0:#DCDCAA;--1:#6F42C1>x-cache:</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>MISS,</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>HIT,</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>HIT,</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>HIT</span></div></div><div class=ec-line><div class=code><span style=--0:#DCDCAA;--1:#6F42C1>x-cache-hits:</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>0,</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>37,</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>1,</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#B5CEA8;--1:#005CC5>0</span></div></div></code></pre><div class=copy><button data-code="curl -sI -H &#x27;Fastly-Debug: 1&#x27; https://aemshop.net/scripts/aem.js | grep &#x27;x-cache\|surrogate-key\|cache-control&#x27;content-encoding: gzipsurrogate-key: develop--aem-boilerplate-commerce--hlxsites develop--aem-boilerplate-commerce--hlxsites_code E3hjdgev7F5OyPUDx-cache: MISS, HIT, HIT, HITx-cache-hits: 0, 37, 1, 0" data-copied=Copied! title="Copy to clipboard"><div></div></button></div></figure></div><ul><li><p>content-encoding should be gzip or br for things like JS assets and HTML files which should be encoded from origin.</p></li><li><p>surrogate-key should not be ‘text’. If the value is ‘text’, make sure you have correctly configured the fetch VCL snippet to return deliver for Edge Delivery paths. The reason for this validation step is that the default Commerce Fastly VCL sets this here: <a href=https://github.com/fastly/fastly-magento2/blob/fdd616cd0f945530e02e92e594ca00fd7990f557/etc/vcl_snippets/fetch.vcl#L113>https://github.com/fastly/fastly-magento2/blob/fdd616cd0f945530e02e92e594ca00fd7990f557/etc/vcl_snippets/fetch.vcl#L113</a>. This overwrites the Edge Delivery surrogate key, which is required for cache invalidation to work correctly when a page is re-published.</p></li><li><p>x-cache should contain HIT entries. The last entry should be HIT ie (MISS, HIT, MISS, HIT) is OK.</p></li></ul><p>Also make sure you validate that gzip encoding is applied to html pages:</p><div class=expressive-code><figure class="frame not-content is-terminal"><figcaption class=header><span class=title></span><span class=sr-only>Terminal window</span></figcaption><pre data-language=bash><code><div class=ec-line><div class=code><span style=--0:#DCDCAA;--1:#6F42C1>curl</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#569CD6;--1:#005CC5>-sI</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#569CD6;--1:#005CC5>-H</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>'accept-encoding: gzip, deflate, br, zstd'</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>https://aemshop.net</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#D4D4D4;--1:#BF3441>|</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#DCDCAA;--1:#6F42C1>grep</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>content-encoding</span></div></div><div class=ec-line><div class=code><span style=--0:#DCDCAA;--1:#6F42C1>content-encoding:</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>gzip</span></div></div><div class=ec-line><div class=code>
</div></div><div class=ec-line><div class=code><span style=--0:#DCDCAA;--1:#6F42C1>curl</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#569CD6;--1:#005CC5>-sI</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#569CD6;--1:#005CC5>-H</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>'accept-encoding: gzip, deflate, br, zstd'</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>https://aemshop.net/index.plain.html</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#D4D4D4;--1:#BF3441>|</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#DCDCAA;--1:#6F42C1>grep</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>content-encoding</span></div></div><div class=ec-line><div class=code><span style=--0:#DCDCAA;--1:#6F42C1>content-encoding:</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>gzip</span></div></div></code></pre><div class=copy><button data-code="curl -sI -H &#x27;accept-encoding: gzip, deflate, br, zstd&#x27; https://aemshop.net | grep content-encodingcontent-encoding: gzipcurl -sI -H &#x27;accept-encoding: gzip, deflate, br, zstd&#x27; https://aemshop.net/index.plain.html | grep content-encodingcontent-encoding: gzip" data-copied=Copied! title="Copy to clipboard"><div></div></button></div></figure></div><ul><li>Validate the CDN configuration via the BYOCDN push invalidator tool from <a href=https://tools.aem.live/ >https://tools.aem.live/</a>.</li><li>Additionally, preview and publish a document and validate that the changes are correctly reflected.</li></ul><div class=expressive-code><figure class="frame not-content is-terminal"><figcaption class=header><span class=title></span><span class=sr-only>Terminal window</span></figcaption><pre data-language=bash><code><div class=ec-line><div class=code><span style=--0:#DCDCAA;--1:#6F42C1>curl</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#569CD6;--1:#005CC5>-Is</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#569CD6;--1:#005CC5>--http2</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>https://www.aemshop.net</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#D4D4D4;--1:#BF3441>|</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#DCDCAA;--1:#6F42C1>grep</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>'HTTP/2'</span></div></div><div class=ec-line><div class=code><span style=--0:#DCDCAA;--1:#6F42C1>HTTP/2</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#B5CEA8;--1:#005CC5>200</span></div></div></code></pre><div class=copy><button data-code="curl -Is --http2 https://www.aemshop.net | grep &#x27;HTTP/2&#x27;HTTP/2 200" data-copied=Copied! title="Copy to clipboard"><div></div></button></div></figure></div><p>Validate that all requests are using HTTP/2 or HTTP/3 connections.</p><div class=expressive-code><figure class="frame not-content is-terminal"><figcaption class=header><span class=title></span><span class=sr-only>Terminal window</span></figcaption><pre data-language=bash><code><div class=ec-line><div class=code><span style=--0:#DCDCAA;--1:#6F42C1>curl</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#569CD6;--1:#005CC5>-Is</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#569CD6;--1:#005CC5>-L</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>https://aemshop.net</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#D4D4D4;--1:#BF3441>|</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#DCDCAA;--1:#6F42C1>grep</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>location</span></div></div><div class=ec-line><div class=code><span style=--0:#DCDCAA;--1:#6F42C1>location:</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>https://www.aemshop.net/</span></div></div></code></pre><div class=copy><button data-code="curl -Is -L https://aemshop.net | grep locationlocation: https://www.aemshop.net/" data-copied=Copied! title="Copy to clipboard"><div></div></button></div></figure></div><p>To validate the APEX redirect, observe the Location header returned by a request to the domain without <a href=http://www>www</a>.</p><h3 id=eds-and-commerce-image-optimization>EDS and Commerce image optimization</h3><p>Validate that images are encoded with expected format. If you get back image/jpeg this would indicate some issue, probably Commerce Fastly is rewriting the content type header. You’ll need to validate the VCL snippets.</p><p>To validate EDS, ensure you check some content expected to be served from EDS origin (such as the hero banner).</p><div class=expressive-code><figure class="frame not-content is-terminal"><figcaption class=header><span class=title></span><span class=sr-only>Terminal window</span></figcaption><pre data-language=bash><code><div class=ec-line><div class=code><span style=--0:#DCDCAA;--1:#6F42C1>curl</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#569CD6;--1:#005CC5>-sI</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#569CD6;--1:#005CC5>-H</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>"Accept: image/webp"</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>'https://aemshop.net/media_12ddec51160a77274a1111c5c7ec6a80ea5c5c2ef.jpeg?width=2000&#x26;format=webply&#x26;optimize=medium'</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#D4D4D4;--1:#BF3441>|</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#DCDCAA;--1:#6F42C1>grep</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>'content-type'</span></div></div><div class=ec-line><div class=code><span style=--0:#DCDCAA;--1:#6F42C1>content-type:</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>image/webp</span></div></div></code></pre><div class=copy><button data-code="curl -sI -H &#x22;Accept: image/webp&#x22; &#x27;https://aemshop.net/media_12ddec51160a77274a1111c5c7ec6a80ea5c5c2ef.jpeg?width=2000&#x26;format=webply&#x26;optimize=medium&#x27; | grep &#x27;content-type&#x27;content-type: image/webp" data-copied=Copied! title="Copy to clipboard"><div></div></button></div></figure></div><p>To validate Commerce, ensure you check some content expected to be served from EDS origin (such as a product image).</p><div class=expressive-code><figure class="frame not-content is-terminal"><figcaption class=header><span class=title></span><span class=sr-only>Terminal window</span></figcaption><pre data-language=bash><code><div class=ec-line><div class=code><span style=--0:#DCDCAA;--1:#6F42C1>curl</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#569CD6;--1:#005CC5>-sI</span><span style=--0:#D4D4D4;--1:#24292E>  </span><span style=--0:#569CD6;--1:#005CC5>-H</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>"Accept: image/webp"</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>'https://aemshop.net/media/catalog/product/m/b/mb03-black-0.jpg?quality=80&#x26;bg-color=255%2C255%2C255&#x26;fit=cover&#x26;height=&#x26;width=300&#x26;auto=webp&#x26;crop=false'</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#D4D4D4;--1:#BF3441>|</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#DCDCAA;--1:#6F42C1>grep</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>'content-type'</span></div></div><div class=ec-line><div class=code><span style=--0:#DCDCAA;--1:#6F42C1>content-type:</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>image/webp</span></div></div></code></pre><div class=copy><button data-code="curl -sI  -H &#x22;Accept: image/webp&#x22; &#x27;https://aemshop.net/media/catalog/product/m/b/mb03-black-0.jpg?quality=80&#x26;bg-color=255%2C255%2C255&#x26;fit=cover&#x26;height=&#x26;width=300&#x26;auto=webp&#x26;crop=false&#x27; | grep &#x27;content-type&#x27;content-type: image/webp" data-copied=Copied! title="Copy to clipboard"><div></div></button></div></figure></div><h3 id=commerce-cache>Commerce cache</h3><p>Ensure GQL GET requests result in cache HITs.</p><div class=expressive-code><figure class="frame not-content is-terminal"><figcaption class=header><span class=title></span><span class=sr-only>Terminal window</span></figcaption><pre data-language=bash><code><div class=ec-line><div class=code><span style=--0:#DCDCAA;--1:#6F42C1>curl</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#569CD6;--1:#005CC5>-sI</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>'https://aemshop.net/graphql?query=query+STORE_CONFIG_QUERY+%7B+storeConfig+%7B+minicart_display%7D+%7D'</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#D4D4D4;--1:#BF3441>|</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#DCDCAA;--1:#6F42C1>grep</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>x-cache</span></div></div><div class=ec-line><div class=code><span style=--0:#DCDCAA;--1:#6F42C1>x-cache:</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#CE9178;--1:#032F62>HIT</span></div></div><div class=ec-line><div class=code><span style=--0:#DCDCAA;--1:#6F42C1>x-cache-hits:</span><span style=--0:#D4D4D4;--1:#24292E> </span><span style=--0:#B5CEA8;--1:#005CC5>1</span></div></div></code></pre><div class=copy><button data-code="curl -sI &#x27;https://aemshop.net/graphql?query=query+STORE_CONFIG_QUERY+%7B+storeConfig+%7B+minicart_display%7D+%7D&#x27; | grep x-cachex-cache: HITx-cache-hits: 1" data-copied=Copied! title="Copy to clipboard"><div></div></button></div></figure></div><h3 id=commerce-base-url>Commerce base URL</h3><p>Ensure Base URL change is propagated to Catalog Service. You can do this with a query against your catalog service API, to check that the urls for product images contains the apex domain, including <a href=http://www>www</a>. This is to prevent a redirect and subsequent load for images not including the apex domain.</p><p><starlight-image-zoom-zoomable><img alt="Commerce base URL" height=582 src=/microsite-commerce-storefront/_astro/commerce-base-url.DUntVF8e_2i69ot.webp width=1990 data-image-component=true decoding=async loading=lazy><button class=starlight-image-zoom-control aria-label="Zoom image: Commerce base URL"><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true><use href=#starlight-image-zoom-icon-zoom></use></svg></button></starlight-image-zoom-zoomable></p><h2 id=debugging>Debugging</h2><p>The full VCL script can be viewed, to see where which VCL snippet is applied, in which order. On the Admin UI panel, go to Tools (sibling of the VCL Snippets dropdown), select “List all Versions” and click the eye icon of the latest version to view the full generated VCL.</p></div><footer class="sl-flex astro-owwkwkko"><div class="sl-flex astro-owwkwkko meta"><a href=https://github.com/commerce-docs/microsite-commerce-storefront/edit/develop/src/content/docs/implementation/setup/content-delivery-network.mdx class="sl-flex astro-y5vay7ab"><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-o5yzykuj astro-y5vay7ab" style=--sl-icon-size:1.2em height=16 width=16><path d="M22 7.24a1 1 0 0 0-.29-.71l-4.24-4.24a1 1 0 0 0-1.1-.22 1 1 0 0 0-.32.22l-2.83 2.83L2.29 16.05a1 1 0 0 0-.29.71V21a1 1 0 0 0 1 1h4.24a1 1 0 0 0 .76-.29l10.87-10.93L21.71 8c.1-.1.17-.2.22-.33a1 1 0 0 0 0-.24v-.14l.07-.05ZM6.83 20H4v-2.83l9.93-9.93 2.83 2.83L6.83 20ZM18.17 8.66l-2.83-2.83 1.42-1.41 2.82 2.82-1.41 1.42Z"/></svg> Edit page</a><p>Last updated: <time datetime=2024-10-11T15:27:25.000Z>Oct 11, 2024</time></p></div><div class="astro-5r2yt2lu pagination-links" dir=ltr><a href=/microsite-commerce-storefront/implementation/setup/ class=astro-5r2yt2lu rel=prev><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-ixejw5kg astro-5r2yt2lu" style=--sl-icon-size:1.5rem><title></title><path d="M17 11H9.41l3.3-3.29a1.004 1.004 0 1 0-1.42-1.42l-5 5a1 1 0 0 0-.21.33 1 1 0 0 0 0 .76 1 1 0 0 0 .21.33l5 5a1.002 1.002 0 0 0 1.639-.325 1 1 0 0 0-.219-1.095L9.41 13H17a1 1 0 0 0 0-2Z"/></svg><div class="astro-5r2yt2lu pb-3 pt-0"><div class="astro-5r2yt2lu text-gray-500 text-sm">Previous</div><div class="astro-5r2yt2lu flex-column"><div class="astro-5r2yt2lu text-base text-red-600">Setup</div><div class="astro-5r2yt2lu link-title">Overview</div></div></div></a><a href=/microsite-commerce-storefront/implementation/setup/commerce-configuration/ class=astro-5r2yt2lu rel=next><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true class="astro-ixejw5kg astro-5r2yt2lu" style=--sl-icon-size:1.5rem><title></title><path d="M17.92 11.62a1.001 1.001 0 0 0-.21-.33l-5-5a1.003 1.003 0 1 0-1.42 1.42l3.3 3.29H7a1 1 0 0 0 0 2h7.59l-3.3 3.29a1.002 1.002 0 0 0 .325 1.639 1 1 0 0 0 1.095-.219l5-5a1 1 0 0 0 .21-.33 1 1 0 0 0 0-.76Z"/></svg><div class="astro-5r2yt2lu pb-3 pt-0"><div class="astro-5r2yt2lu text-gray-500 text-sm">Next</div><div class="astro-5r2yt2lu flex-column"><div class="astro-5r2yt2lu text-base text-red-600">Commerce Configuration</div><div class="astro-5r2yt2lu link-title">Commerce configuration</div></div></div></a></div></footer></div></div></main></div></div></div></div></body></html>